# ç¼“å­˜æ™ºèƒ½æ—¥æœŸåŒ¹é…ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³ç¼“å­˜å†—ä½™é—®é¢˜ï¼šå½“å·²æœ‰å¤§èŒƒå›´ç¼“å­˜æ—¶ï¼ŒæŸ¥è¯¢å°èŒƒå›´æ•°æ®ä¸åº”è¯¥åˆ›å»ºæ–°ç¼“å­˜ï¼Œè€Œåº”è¯¥ä»ç°æœ‰ç¼“å­˜ä¸­è¿‡æ»¤æ•°æ®ã€‚

---

## ğŸ“‹ ä¼˜åŒ–å‰çš„é—®é¢˜

### åœºæ™¯ç¤ºä¾‹ï¼š

```python
# ç¬¬1æ¬¡ï¼šç¼“å­˜ 2024-01-01 ~ 2024-12-31ï¼ˆå…¨å¹´æ•°æ®ï¼‰
df1 = get_cached_stock_data('000001', date(2024,1,1), date(2024,12,31), ...)
# â†’ åˆ›å»ºç¼“å­˜æ–‡ä»¶: 000001_20240101_20241231.parquet

# ç¬¬2æ¬¡ï¼šæŸ¥è¯¢ 2024-03-01 ~ 2024-06-30ï¼ˆ3-6æœˆæ•°æ®ï¼‰
df2 = get_cached_stock_data('000001', date(2024,3,1), date(2024,6,30), ...)
# âŒ é—®é¢˜ï¼šä¼šåˆ›å»ºæ–°ç¼“å­˜æ–‡ä»¶: 000001_20240301_20240630.parquet
# âŒ å¯¼è‡´ï¼šé‡å¤å­˜å‚¨ï¼Œæµªè´¹ç©ºé—´
```

**é—®é¢˜ï¼š**
- æŸ¥è¯¢çš„æ—¥æœŸèŒƒå›´å·²ç»è¢«ç°æœ‰ç¼“å­˜å®Œå…¨è¦†ç›–
- ä½†å› ä¸ºç¼“å­˜é”®ä¸åŒï¼Œç³»ç»Ÿä¸çŸ¥é“å¯ä»¥å¤ç”¨
- å¯¼è‡´åˆ›å»ºå¤šä¸ªé‡å¤çš„ç¼“å­˜æ–‡ä»¶

---

## âœ… ä¼˜åŒ–åçš„è¡Œä¸º

### æ™ºèƒ½æ—¥æœŸåŒ¹é…é€»è¾‘ï¼š

```python
# ç¬¬1æ¬¡ï¼šç¼“å­˜ 2024-01-01 ~ 2024-12-31ï¼ˆå…¨å¹´æ•°æ®ï¼‰
df1 = get_cached_stock_data('000001', date(2024,1,1), date(2024,12,31), ...)
# â†’ åˆ›å»ºç¼“å­˜: 000001_20240101_20241231.parquet (243æ¡è®°å½•)

# ç¬¬2æ¬¡ï¼šæŸ¥è¯¢ 2024-03-01 ~ 2024-06-30ï¼ˆ3-6æœˆæ•°æ®ï¼‰
df2 = get_cached_stock_data('000001', date(2024,3,1), date(2024,6,30), ...)
# âœ… æ™ºèƒ½åŒ¹é…ï¼šå‘ç°å·²æœ‰ç¼“å­˜è¦†ç›–æ­¤èŒƒå›´
# âœ… ä»å¤§ç¼“å­˜ä¸­è¿‡æ»¤: è¿”å›60æ¡è®°å½•
# âœ… ä¸åˆ›å»ºæ–°ç¼“å­˜
```

**ä¼˜åŠ¿ï¼š**
- é¿å…é‡å¤ç¼“å­˜
- èŠ‚çœå­˜å‚¨ç©ºé—´
- å……åˆ†åˆ©ç”¨ç°æœ‰ç¼“å­˜

---

## ğŸ” å®ç°åŸç†

### ä¸¤çº§æŸ¥è¯¢ç­–ç•¥ï¼š

#### ç¬¬1çº§ï¼šç²¾ç¡®åŒ¹é…ï¼ˆæœ€å¿«ï¼‰
```python
# ç”ŸæˆæŸ¥è¯¢çš„ç¼“å­˜é”®
cache_key = "tushare_a_stock_000001_20240301_20240630_1d"

# æŸ¥æ‰¾ç²¾ç¡®åŒ¹é…çš„ç¼“å­˜
if index.has_entry(cache_key):
    return cached_data  # ç›´æ¥è¿”å›
```

#### ç¬¬2çº§ï¼šæ™ºèƒ½èŒƒå›´åŒ¹é…ï¼ˆå›é€€ç­–ç•¥ï¼‰
```python
# å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼ŒæŸ¥æ‰¾èƒ½è¦†ç›–æ­¤èŒƒå›´çš„æ›´å¤§ç¼“å­˜

# æå–æŸ¥è¯¢çš„åŸºæœ¬ä¿¡æ¯
data_source = "tushare"
market = "a_stock"
code = "000001"
interval = "1d"
query_start = 2024-03-01
query_end = 2024-06-30

# éå†æ‰€æœ‰åŒèµ„äº§çš„ç¼“å­˜
for cache in all_caches:
    if (cache.data_source == data_source and
        cache.market == market and
        cache.code == code and
        cache.interval == interval):
        
        # æ£€æŸ¥æ—¥æœŸèŒƒå›´
        if cache.start_date <= query_start and cache.end_date >= query_end:
            # âœ… æ‰¾åˆ°èƒ½è¦†ç›–çš„ç¼“å­˜ï¼
            # è¯»å–å¹¶è¿‡æ»¤æ•°æ®
            data = load_cache(cache)
            filtered_data = data[(date >= query_start) & (date <= query_end)]
            return filtered_data
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### åœºæ™¯ï¼šæŸ¥è¯¢åŒä¸€èµ„äº§çš„ä¸åŒæ—¥æœŸèŒƒå›´

| æŸ¥è¯¢ | æ—¥æœŸèŒƒå›´ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|---------|--------|--------|
| ç¬¬1æ¬¡ | 2024-01-01 ~ 2024-12-31 | åˆ›å»ºç¼“å­˜ (243æ¡) | åˆ›å»ºç¼“å­˜ (243æ¡) |
| ç¬¬2æ¬¡ | 2024-03-01 ~ 2024-06-30 | âŒ åˆ›å»ºæ–°ç¼“å­˜ (60æ¡) | âœ… å¤ç”¨ç¼“å­˜ï¼Œè¿‡æ»¤ (60æ¡) |
| ç¬¬3æ¬¡ | 2024-01-01 ~ 2024-02-28 | âŒ åˆ›å»ºæ–°ç¼“å­˜ (40æ¡) | âœ… å¤ç”¨ç¼“å­˜ï¼Œè¿‡æ»¤ (40æ¡) |
| ç¬¬4æ¬¡ | 2024-07-01 ~ 2024-09-30 | âŒ åˆ›å»ºæ–°ç¼“å­˜ (65æ¡) | âœ… å¤ç”¨ç¼“å­˜ï¼Œè¿‡æ»¤ (65æ¡) |

**ä¼˜åŒ–å‰ï¼š** 4ä¸ªç¼“å­˜æ–‡ä»¶ï¼Œ408æ¡è®°å½•ï¼ˆå¤§é‡é‡å¤ï¼‰
**ä¼˜åŒ–åï¼š** 1ä¸ªç¼“å­˜æ–‡ä»¶ï¼Œ243æ¡è®°å½•ï¼ˆæ— é‡å¤ï¼‰âœ¨

---

## ğŸ¯ åŒ¹é…æ¡ä»¶

è¦æˆåŠŸåŒ¹é…ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹**æ‰€æœ‰æ¡ä»¶**ï¼š

### 1. èµ„äº§ç›¸åŒ
```python
âœ… æ•°æ®æºç›¸åŒ (data_source)
âœ… å¸‚åœºç›¸åŒ (market)
âœ… ä»£ç ç›¸åŒ (code)
âœ… æ—¶é—´ç²’åº¦ç›¸åŒ (interval)
```

### 2. æ—¥æœŸè¦†ç›–
```python
cache_start <= query_start  AND  cache_end >= query_end

ç¤ºä¾‹ï¼š
ç¼“å­˜: 2024-01-01 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 2024-12-31
æŸ¥è¯¢:      2024-03-01 â”â”â”â”â”â”â”â” 2024-06-30
       âœ… å®Œå…¨è¦†ç›–ï¼Œå¯ä»¥ä½¿ç”¨
```

### 3. ç¼“å­˜æœ‰æ•ˆ
```python
âœ… æœªè¿‡æœŸ (TTLæ£€æŸ¥)
âœ… æ–‡ä»¶å­˜åœ¨
âœ… æ•°æ®å¯è¯»
```

---

## ğŸ’¡ å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå¹´åº¦æ•°æ® + å­£åº¦æŸ¥è¯¢

```python
from cached_data_source import get_cached_stock_data
import datetime

# æ­¥éª¤1ï¼šè·å–å…¨å¹´æ•°æ®ï¼ˆåˆ›å»ºå¤§ç¼“å­˜ï¼‰
df_year = get_cached_stock_data(
    '000001',
    datetime.date(2024, 1, 1),
    datetime.date(2024, 12, 31),
    market='Aè‚¡',
    source_type='tushare'
)
# è¾“å‡º: ğŸŒ ä»APIè·å–æ•°æ®: 000001
#       ğŸ’¾ æ•°æ®å·²ç¼“å­˜: 000001

# æ­¥éª¤2ï¼šæŸ¥è¯¢Q1æ•°æ®ï¼ˆä½¿ç”¨å¤§ç¼“å­˜ï¼‰
df_q1 = get_cached_stock_data(
    '000001',
    datetime.date(2024, 1, 1),
    datetime.date(2024, 3, 31),
    market='Aè‚¡',
    source_type='tushare'
)
# è¾“å‡º: ğŸ¯ ä½¿ç”¨ç¼“å­˜æ•°æ®: 000001 (60 æ¡è®°å½•)
#       âœ… ä»ç¼“å­˜è¿‡æ»¤æ•°æ®: 60 æ¡è®°å½• (åŸç¼“å­˜: 243 æ¡)

# æ­¥éª¤3ï¼šæŸ¥è¯¢Q2æ•°æ®ï¼ˆä½¿ç”¨å¤§ç¼“å­˜ï¼‰
df_q2 = get_cached_stock_data(
    '000001',
    datetime.date(2024, 4, 1),
    datetime.date(2024, 6, 30),
    market='Aè‚¡',
    source_type='tushare'
)
# è¾“å‡º: ğŸ¯ ä½¿ç”¨ç¼“å­˜æ•°æ®: 000001 (61 æ¡è®°å½•)
#       âœ… ä»ç¼“å­˜è¿‡æ»¤æ•°æ®: 61 æ¡è®°å½• (åŸç¼“å­˜: 243 æ¡)

# ç»“æœï¼šåªæœ‰1ä¸ªç¼“å­˜æ–‡ä»¶ï¼Œ3æ¬¡æŸ¥è¯¢éƒ½èƒ½å¿«é€Ÿå“åº”
```

### ç¤ºä¾‹2ï¼šStreamlit åº”ç”¨ä¸­çš„åº”ç”¨

```python
# ç”¨æˆ·åœºæ™¯ï¼šå›æµ‹ä¸åŒæ—¶é—´æ®µ

# å›æµ‹1ï¼šå…¨å¹´
# æ—¥æœŸ: 2024-01-01 ~ 2024-12-31
# â†’ åˆ›å»ºç¼“å­˜

# å›æµ‹2ï¼šä¸ŠåŠå¹´
# æ—¥æœŸ: 2024-01-01 ~ 2024-06-30
# â†’ ä½¿ç”¨å…¨å¹´ç¼“å­˜ï¼Œè¿‡æ»¤æ•°æ® âœ¨

# å›æµ‹3ï¼šä¸‹åŠå¹´
# æ—¥æœŸ: 2024-07-01 ~ 2024-12-31
# â†’ ä½¿ç”¨å…¨å¹´ç¼“å­˜ï¼Œè¿‡æ»¤æ•°æ® âœ¨

# å›æµ‹4ï¼šæŸä¸ªæœˆ
# æ—¥æœŸ: 2024-03-01 ~ 2024-03-31
# â†’ ä½¿ç”¨å…¨å¹´ç¼“å­˜ï¼Œè¿‡æ»¤æ•°æ® âœ¨

# æ‰€æœ‰å›æµ‹éƒ½æå¿«ï¼ˆ<0.1ç§’ï¼‰ï¼Œåªç”¨äº†1ä¸ªç¼“å­˜æ–‡ä»¶
```

---

## ğŸ”§ å¦‚ä½•æµ‹è¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test/test_smart_cache.py
```

### é¢„æœŸè¾“å‡ºï¼š

```
ã€åœºæ™¯1ã€‘ç¼“å­˜å¤§èŒƒå›´æ•°æ®ï¼š2024-01-01 ~ 2024-12-31
âœ… å¤§èŒƒå›´æ•°æ®è·å–æˆåŠŸ: 243 æ¡è®°å½•

ã€åœºæ™¯2ã€‘æŸ¥è¯¢å°èŒƒå›´æ•°æ®ï¼š2024-03-01 ~ 2024-06-30
âœ… å°èŒƒå›´æ•°æ®è·å–æˆåŠŸ: 60 æ¡è®°å½•
âœ… æ—¥æœŸèŒƒå›´æ­£ç¡®è¿‡æ»¤
âœ… ä»ç¼“å­˜è¿‡æ»¤æ•°æ®: 60 æ¡è®°å½• (åŸç¼“å­˜: 243 æ¡)

ã€åœºæ™¯3ã€‘æ£€æŸ¥ç¼“å­˜æ–‡ä»¶
ç¼“å­˜æ–‡ä»¶æ•°é‡: 1 ä¸ª
   - 000001_20240101_20241231.parquet (12.5 KB)
âœ… ä¼˜åŒ–æˆåŠŸï¼åªæœ‰å¤§èŒƒå›´ç¼“å­˜ï¼Œæ²¡æœ‰åˆ›å»ºå°èŒƒå›´ç¼“å­˜

ã€åœºæ™¯4ã€‘å¤šæ¬¡æŸ¥è¯¢ä¸åŒå°èŒƒå›´
âœ… 1-2æœˆ: 40 æ¡è®°å½•
âœ… 4-5æœˆ: 42 æ¡è®°å½•
âœ… 7-9æœˆ: 65 æ¡è®°å½•

ã€åœºæ™¯5ã€‘ç¼“å­˜ç»Ÿè®¡
ç¼“å­˜æ€»æ•°: 1 ä¸ª
000001 çš„ç¼“å­˜:
   - 2024-01-01 ~ 2024-12-31
     è®¿é—®æ¬¡æ•°: 5
     å¤§å°: 12.5 KB
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½å½±å“
- **ç²¾ç¡®åŒ¹é…**ï¼šO(1) æ—¶é—´å¤æ‚åº¦
- **èŒƒå›´åŒ¹é…**ï¼šO(n) æ—¶é—´å¤æ‚åº¦ï¼ˆn = åŒèµ„äº§çš„ç¼“å­˜æ•°é‡ï¼‰
- å®é™…å½±å“å¾ˆå°ï¼ˆé€šå¸¸åŒä¸€èµ„äº§çš„ç¼“å­˜æ•°é‡ < 10ï¼‰

### 2. è¾¹ç•Œæƒ…å†µ

#### æƒ…å†µAï¼šæŸ¥è¯¢èŒƒå›´è¶…å‡ºç¼“å­˜
```python
ç¼“å­˜: 2024-01-01 ~ 2024-06-30
æŸ¥è¯¢: 2024-01-01 ~ 2024-12-31
ç»“æœ: âŒ ä¸åŒ¹é…ï¼Œä¼šé‡æ–°è·å–å¹¶åˆ›å»ºæ–°ç¼“å­˜
```

#### æƒ…å†µBï¼šéƒ¨åˆ†é‡å 
```python
ç¼“å­˜: 2024-01-01 ~ 2024-06-30
æŸ¥è¯¢: 2024-04-01 ~ 2024-09-30
ç»“æœ: âŒ ä¸åŒ¹é…ï¼ˆéƒ¨åˆ†è¶…å‡ºï¼‰ï¼Œä¼šé‡æ–°è·å–
```

#### æƒ…å†µCï¼šå®Œå…¨åŒ…å«
```python
ç¼“å­˜: 2024-01-01 ~ 2024-12-31
æŸ¥è¯¢: 2024-03-01 ~ 2024-06-30
ç»“æœ: âœ… åŒ¹é…ï¼Œä»ç¼“å­˜è¿‡æ»¤
```

### 3. å¤šä¸ªåŒ¹é…ç¼“å­˜
- å¦‚æœæœ‰å¤šä¸ªç¼“å­˜éƒ½èƒ½è¦†ç›–æŸ¥è¯¢èŒƒå›´
- ç³»ç»Ÿä¼šä½¿ç”¨**ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æœ‰æ•ˆç¼“å­˜**
- å»ºè®®å®šæœŸæ¸…ç†å†—ä½™ç¼“å­˜

---

## ğŸ‰ æ€»ç»“

### ä¼˜åŒ–æˆæœï¼š

âœ… **é¿å…é‡å¤ç¼“å­˜** - ç›¸åŒæ•°æ®ä¸ä¼šé‡å¤å­˜å‚¨
âœ… **èŠ‚çœå­˜å‚¨ç©ºé—´** - ç¼“å­˜æ–‡ä»¶æ•°é‡å¤§å¹…å‡å°‘
âœ… **æ€§èƒ½æ— æŸå¤±** - æŸ¥è¯¢é€Ÿåº¦ä¾ç„¶æå¿«
âœ… **æ™ºèƒ½å›é€€** - ç²¾ç¡®åŒ¹é…å¤±è´¥æ—¶è‡ªåŠ¨å°è¯•èŒƒå›´åŒ¹é…
âœ… **é€æ˜ä½¿ç”¨** - ç”¨æˆ·æ— éœ€ä»»ä½•æ”¹åŠ¨

### é€‚ç”¨åœºæ™¯ï¼š

- ğŸ“Š å…ˆè·å–å…¨å¹´æ•°æ®ï¼Œåç»­æŒ‰æœˆ/å­£åº¦å›æµ‹
- ğŸ”„ å¤šæ¬¡æŸ¥è¯¢åŒä¸€èµ„äº§çš„ä¸åŒæ—¶é—´æ®µ
- ğŸ’¾ éœ€è¦ä¼˜åŒ–å­˜å‚¨ç©ºé—´çš„åœºæ™¯
- âš¡ éœ€è¦å¿«é€Ÿå“åº”çš„äº¤äº’å¼åº”ç”¨

---

**æ›´æ–°æ—¥æœŸ**: 2026-02-13  
**ç‰ˆæœ¬**: v1.2.0  
**çŠ¶æ€**: âœ… å·²å®ç°å¹¶æµ‹è¯•
