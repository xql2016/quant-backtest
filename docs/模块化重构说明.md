# é‡åŒ–å›æµ‹ç³»ç»Ÿæ¨¡å—åŒ–é‡æ„è¯´æ˜

## ğŸ“‹ é‡æ„æ¦‚è¿°

åŸæœ‰çš„å•æ–‡ä»¶ `å¤šç­–ç•¥å¯è§†åŒ–å›æµ‹_å°çº¢ä¹¦20260117.py` å·²è¢«é‡æ„ä¸ºæ›´åŠ æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤çš„ç»“æ„ï¼Œåˆ†ä¸ºä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ï¼š

1. **æ•°æ®æºè·å–æ¨¡å—** (`data_source.py`)
2. **ç­–ç•¥ä¸å›æµ‹æ¨¡å—** (`strategy_backtest.py`)

---

## ğŸ—‚ï¸ æ¨¡å—ç»“æ„

### 1. æ•°æ®æºè·å–æ¨¡å— (`data_source.py`)

**åŠŸèƒ½ï¼š** è´Ÿè´£ä»ä¸åŒæ•°æ®æºè·å–è‚¡ç¥¨æ•°æ®ï¼Œå¹¶ç»Ÿä¸€æ•°æ®æ ¼å¼

#### æ ¸å¿ƒç±»ï¼š

- **`DataSource`** (æŠ½è±¡åŸºç±»)
  - å®šä¹‰æ•°æ®æºçš„æ ‡å‡†æ¥å£
  - ç¡®ä¿æ‰€æœ‰æ•°æ®æºè¿”å›ç»Ÿä¸€æ ¼å¼

- **`AKShareDataSource`** (å½“å‰å®ç°)
  - æ”¯æŒAè‚¡ã€æ¸¯è‚¡æ•°æ®è·å–ï¼ˆé€šè¿‡AKShareï¼‰
  - æ”¯æŒç¾è‚¡æ•°æ®è·å–ï¼ˆé€šè¿‡yfinanceï¼‰
  - è‡ªåŠ¨æ ‡å‡†åŒ–æ•°æ®æ ¼å¼

- **`CSVDataSource`** (æ‰©å±•ç¤ºä¾‹)
  - ä»æœ¬åœ°CSVæ–‡ä»¶è¯»å–æ•°æ®
  - é€‚åˆç¦»çº¿å›æµ‹æˆ–è‡ªå®šä¹‰æ•°æ®

- **`DatabaseDataSource`** (æ‰©å±•ç¤ºä¾‹)
  - ä»æ•°æ®åº“è¯»å–æ•°æ®
  - é€‚åˆä¼ä¸šçº§åº”ç”¨

- **`DataSourceFactory`** (å·¥å‚ç±»)
  - ç»Ÿä¸€åˆ›å»ºä¸åŒç±»å‹çš„æ•°æ®æº

#### ä½¿ç”¨ç¤ºä¾‹ï¼š

```python
from data_source import get_stock_data

# ä½¿ç”¨AKShareè·å–Aè‚¡æ•°æ®
df = get_stock_data(
    code='000001', 
    start_date=datetime.date(2023, 1, 1),
    end_date=datetime.date(2024, 1, 1),
    market='Aè‚¡',
    source_type='akshare'
)

# ä½¿ç”¨CSVæ•°æ®æºï¼ˆéœ€è¦å…ˆå®ç°ï¼‰
df = get_stock_data(
    code='000001', 
    start_date=datetime.date(2023, 1, 1),
    end_date=datetime.date(2024, 1, 1),
    source_type='csv',
    csv_dir='./data'  # é¢å¤–å‚æ•°
)
```

#### æ•°æ®æ ¼å¼æ ‡å‡†ï¼š

æ‰€æœ‰æ•°æ®æºè¿”å›çš„DataFrameå¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼š
- `date` (ç´¢å¼•): æ—¥æœŸ
- `open`: å¼€ç›˜ä»·
- `high`: æœ€é«˜ä»·
- `low`: æœ€ä½ä»·
- `close`: æ”¶ç›˜ä»·
- `volume`: æˆäº¤é‡

---

### 2. ç­–ç•¥ä¸å›æµ‹æ¨¡å— (`strategy_backtest.py`)

**åŠŸèƒ½ï¼š** å®ç°å„ç§äº¤æ˜“ç­–ç•¥å’Œå›æµ‹å¼•æ“

#### æ ¸å¿ƒç±»ï¼š

- **`Strategy`** (æŠ½è±¡åŸºç±»)
  - å®šä¹‰ç­–ç•¥çš„æ ‡å‡†æ¥å£
  - ç¡®ä¿æ‰€æœ‰ç­–ç•¥å®ç°ç»Ÿä¸€çš„ä¿¡å·ç”Ÿæˆæ–¹æ³•

- **å·²å®ç°çš„ç­–ç•¥ï¼š**
  - `MACDStrategy` - MACDè¶‹åŠ¿ç­–ç•¥
  - `DoubleSMAStrategy` - åŒå‡çº¿ç­–ç•¥
  - `RSIStrategy` - RSIè¶…ä¹°è¶…å–ç­–ç•¥
  - `BollingerBandsStrategy` - å¸ƒæ—å¸¦çªç ´ç­–ç•¥
  - `WaveStrategy` - æ³¢æ®µç­–ç•¥
  - `MultipleDivergenceStrategy` - å¤šé‡åº•å…¥åœºç­–ç•¥

- **`BacktestEngine`** (å›æµ‹å¼•æ“)
  - æ‰§è¡Œç­–ç•¥å›æµ‹
  - å¤„ç†ä¹°å–é€»è¾‘
  - è®¡ç®—æ‰‹ç»­è´¹
  - ç”Ÿæˆäº¤æ˜“æ—¥å¿—

- **`BacktestResult`** (æ•°æ®ç±»)
  - å°è£…å›æµ‹ç»“æœ
  - åŒ…å«æ”¶ç›Šç‡ã€èƒœç‡ã€äº¤æ˜“æ¬¡æ•°ç­‰æŒ‡æ ‡

- **`StrategyFactory`** (å·¥å‚ç±»)
  - ç»Ÿä¸€åˆ›å»ºä¸åŒç±»å‹çš„ç­–ç•¥

#### ä½¿ç”¨ç¤ºä¾‹ï¼š

```python
from strategy_backtest import StrategyFactory, BacktestEngine

# åˆ›å»ºç­–ç•¥
params = {'fast': 12, 'slow': 26, 'signal': 9}
strategy = StrategyFactory.create_strategy("MACDè¶‹åŠ¿ç­–ç•¥", params)

# åˆ›å»ºå›æµ‹å¼•æ“
engine = BacktestEngine(initial_cash=100000, commission_rate=0.0003)

# è¿è¡Œå›æµ‹
result = engine.run(df, strategy)

# æŸ¥çœ‹ç»“æœ
print(f"æ€»æ”¶ç›Šç‡: {result.total_return:.2%}")
print(f"èƒœç‡: {result.win_rate:.2%}")
print(f"äº¤æ˜“æ¬¡æ•°: {result.total_trades}")
```

---

## ğŸš€ å¦‚ä½•æ‰©å±•

### æ·»åŠ æ–°çš„æ•°æ®æº

1. ç»§æ‰¿ `DataSource` åŸºç±»
2. å®ç° `fetch_data` æ–¹æ³•
3. ç¡®ä¿è¿”å›æ ‡å‡†åŒ–çš„DataFrameæ ¼å¼
4. åœ¨ `DataSourceFactory` ä¸­æ³¨å†Œæ–°æ•°æ®æº

**ç¤ºä¾‹ï¼š**

```python
class TushareDataSource(DataSource):
    """Tushareæ•°æ®æº"""
    
    def __init__(self, token):
        import tushare as ts
        self.pro = ts.pro_api(token)
    
    def fetch_data(self, code, start_date, end_date, **kwargs):
        # ä»Tushareè·å–æ•°æ®
        df = self.pro.daily(
            ts_code=code, 
            start_date=start_date.strftime('%Y%m%d'),
            end_date=end_date.strftime('%Y%m%d')
        )
        
        # è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
        df = df.rename(columns={
            'trade_date': 'date',
            'open': 'open',
            'high': 'high',
            'low': 'low',
            'close': 'close',
            'vol': 'volume'
        })
        
        df['date'] = pd.to_datetime(df['date'])
        df.set_index('date', inplace=True)
        
        return df
```

### æ·»åŠ æ–°çš„ç­–ç•¥

1. ç»§æ‰¿ `Strategy` åŸºç±»
2. å®ç° `calculate_signals` æ–¹æ³•
3. å®ç° `get_strategy_name` æ–¹æ³•
4. åœ¨ `StrategyFactory` ä¸­æ³¨å†Œæ–°ç­–ç•¥

**ç¤ºä¾‹ï¼š**

```python
class KDJStrategy(Strategy):
    """KDJæŒ‡æ ‡ç­–ç•¥"""
    
    def calculate_signals(self, df):
        df = df.copy()
        df['signal'] = 0
        
        # è®¡ç®—KDJæŒ‡æ ‡
        low_list = df['low'].rolling(window=self.params['period']).min()
        high_list = df['high'].rolling(window=self.params['period']).max()
        
        rsv = (df['close'] - low_list) / (high_list - low_list) * 100
        df['k'] = rsv.ewm(com=2, adjust=False).mean()
        df['d'] = df['k'].ewm(com=2, adjust=False).mean()
        df['j'] = 3 * df['k'] - 2 * df['d']
        
        # ç”Ÿæˆä¿¡å·ï¼šJå€¼ä¸Šç©¿20ä¹°å…¥ï¼Œä¸‹ç©¿80å–å‡º
        df.loc[(df['j'].shift(1) < 20) & (df['j'] > 20), 'signal'] = 1
        df.loc[(df['j'].shift(1) > 80) & (df['j'] < 80), 'signal'] = -1
        
        return df
    
    def get_strategy_name(self):
        return "KDJç­–ç•¥"
```

ç„¶ååœ¨ `StrategyFactory.create_strategy` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
strategy_map = {
    # ... ç°æœ‰ç­–ç•¥ ...
    "KDJç­–ç•¥": KDJStrategy
}
```

---

## ğŸ“Š ä¸»æ–‡ä»¶å˜åŒ–

`å¤šç­–ç•¥å¯è§†åŒ–å›æµ‹_å°çº¢ä¹¦20260117.py` ç°åœ¨å˜å¾—æ›´åŠ ç®€æ´ï¼š

### å˜åŒ–å‰ï¼ˆ641è¡Œï¼‰
- åŒ…å«æ•°æ®è·å–é€»è¾‘
- åŒ…å«æ‰€æœ‰ç­–ç•¥è®¡ç®—é€»è¾‘
- åŒ…å«å›æµ‹å¼•æ“é€»è¾‘
- åŒ…å«UIå±•ç¤ºé€»è¾‘

### å˜åŒ–åï¼ˆçº¦300è¡Œï¼‰
- åªåŒ…å«UIé…ç½®å’Œäº¤äº’
- è°ƒç”¨æ•°æ®æºæ¨¡å—è·å–æ•°æ®
- è°ƒç”¨ç­–ç•¥æ¨¡å—è¿è¡Œå›æµ‹
- ä¸“æ³¨äºç»“æœå±•ç¤ºå’Œå¯è§†åŒ–

### æ ¸å¿ƒæ”¹åŠ¨ï¼š

```python
# æ—§ä»£ç ï¼šç›´æ¥è·å–æ•°æ®
df = get_stock_data(stock_code, start_date, end_date, market_type)

# æ–°ä»£ç ï¼šä½¿ç”¨æ•°æ®æºæ¨¡å—
from data_source import get_stock_data
df = get_stock_data(stock_code, start_date, end_date, market=market_type, source_type='akshare')

# æ—§ä»£ç ï¼šå¤§é‡if-elifåˆ†æ”¯å¤„ç†ä¸åŒç­–ç•¥
if selected_strategy == "MACDè¶‹åŠ¿ç­–ç•¥":
    # 100å¤šè¡Œç­–ç•¥è®¡ç®—ä»£ç 
elif selected_strategy == "åŒå‡çº¿ç­–ç•¥(SMA)":
    # æ›´å¤šç­–ç•¥ä»£ç 
# ... æ›´å¤šåˆ†æ”¯ ...

# æ–°ä»£ç ï¼šç»Ÿä¸€è°ƒç”¨ç­–ç•¥æ¨¡å—
from strategy_backtest import StrategyFactory, BacktestEngine
strategy = StrategyFactory.create_strategy(selected_strategy, params)
engine = BacktestEngine(initial_cash=initial_cash, commission_rate=commission_rate)
result = engine.run(df, strategy)
```

---

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

### 1. **å¯ç»´æŠ¤æ€§æå‡**
- ä»£ç èŒè´£æ¸…æ™°ï¼Œæ¯ä¸ªæ¨¡å—ä¸“æ³¨äºä¸€ä¸ªé¢†åŸŸ
- ä¿®æ”¹æŸä¸ªç­–ç•¥ä¸ä¼šå½±å“å…¶ä»–éƒ¨åˆ†
- æ›´å®¹æ˜“å®šä½å’Œä¿®å¤bug

### 2. **å¯æ‰©å±•æ€§å¢å¼º**
- æ·»åŠ æ–°æ•°æ®æºï¼šåªéœ€å®ç°ä¸€ä¸ªç±»
- æ·»åŠ æ–°ç­–ç•¥ï¼šåªéœ€å®ç°ä¸€ä¸ªç±»
- ä¸éœ€è¦ä¿®æ”¹ä¸»æ–‡ä»¶

### 3. **å¯å¤ç”¨æ€§æé«˜**
- æ•°æ®æºæ¨¡å—å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¸­ä½¿ç”¨
- ç­–ç•¥æ¨¡å—å¯ä»¥ç‹¬ç«‹æµ‹è¯•å’Œä½¿ç”¨
- å›æµ‹å¼•æ“å¯ä»¥ç”¨äºæ‰¹é‡æµ‹è¯•

### 4. **æµ‹è¯•æ›´å®¹æ˜“**
- å¯ä»¥å•ç‹¬æµ‹è¯•æ•°æ®æº
- å¯ä»¥å•ç‹¬æµ‹è¯•ç­–ç•¥é€»è¾‘
- å¯ä»¥å•ç‹¬æµ‹è¯•å›æµ‹å¼•æ“

### 5. **ä»£ç æ›´æ¸…æ™°**
- ä¸»æ–‡ä»¶åªå…³æ³¨UIå’Œç”¨æˆ·äº¤äº’
- ç­–ç•¥å®ç°ç»Ÿä¸€è§„èŒƒ
- æ•°æ®æ ¼å¼ç»Ÿä¸€æ ‡å‡†

---

## ğŸ”§ ä½¿ç”¨å»ºè®®

### æ—¥å¸¸ä½¿ç”¨
- ç›´æ¥è¿è¡Œä¸»æ–‡ä»¶ `å¤šç­–ç•¥å¯è§†åŒ–å›æµ‹_å°çº¢ä¹¦20260117.py`
- åŠŸèƒ½å’Œç•Œé¢ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´

### å¼€å‘æ–°åŠŸèƒ½
1. **æ·»åŠ æ–°æ•°æ®æº**ï¼šä¿®æ”¹ `data_source.py`
2. **æ·»åŠ æ–°ç­–ç•¥**ï¼šä¿®æ”¹ `strategy_backtest.py`
3. **ä¿®æ”¹UI**ï¼šä¿®æ”¹ä¸»æ–‡ä»¶

### æ€§èƒ½ä¼˜åŒ–
- æ•°æ®ç¼“å­˜å·²ä¿ç•™ï¼ˆä½¿ç”¨Streamlitçš„@st.cache_dataï¼‰
- å¯ä»¥åœ¨æ•°æ®æºå±‚é¢æ·»åŠ æ›´å¤šç¼“å­˜ç­–ç•¥
- å¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªç­–ç•¥å›æµ‹

---

## ğŸ“¦ ä¾èµ–è¦æ±‚

```txt
streamlit
pandas
numpy
matplotlib
akshare
yfinance
```

ä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼Œæ— éœ€é¢å¤–å®‰è£…æ–°çš„ä¾èµ–ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šæ–°ç‰ˆæœ¬å®Œå…¨å…¼å®¹æ—§ç‰ˆæœ¬çš„ä½¿ç”¨æ–¹å¼
2. **æ•°æ®æ ¼å¼**ï¼šæ‰€æœ‰æ•°æ®æºå¿…é¡»è¿”å›æ ‡å‡†æ ¼å¼
3. **ç­–ç•¥ä¿¡å·**ï¼šä¿¡å·å€¼å¿…é¡»ä¸º 1ï¼ˆä¹°å…¥ï¼‰ã€-1ï¼ˆå–å‡ºï¼‰ã€0ï¼ˆæŒæœ‰ï¼‰
4. **æ–‡ä»¶å¯¼å…¥**ï¼šç¡®ä¿ `data_source.py` å’Œ `strategy_backtest.py` ä¸ä¸»æ–‡ä»¶åœ¨åŒä¸€ç›®å½•

---

## ğŸ“ å­¦ä¹ å»ºè®®

1. **å…ˆç†è§£æ¥å£**ï¼šæŸ¥çœ‹æŠ½è±¡åŸºç±» `DataSource` å’Œ `Strategy`
2. **çœ‹å®ç°ç¤ºä¾‹**ï¼šç ”ç©¶ `AKShareDataSource` å’Œ `MACDStrategy`
3. **åŠ¨æ‰‹å®è·µ**ï¼šå°è¯•æ·»åŠ ä¸€ä¸ªç®€å•çš„ç­–ç•¥æˆ–æ•°æ®æº
4. **é€æ­¥æ·±å…¥**ï¼šç†è§£å›æµ‹å¼•æ“çš„å®Œæ•´æµç¨‹

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿ï¼š
- æŸ¥çœ‹ä»£ç æ³¨é‡Šï¼ˆä»£ç ä¸­æœ‰è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰
- å‚è€ƒç¤ºä¾‹å®ç°ï¼ˆCSVå’ŒDatabaseæ•°æ®æºï¼‰
- è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½

ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰

