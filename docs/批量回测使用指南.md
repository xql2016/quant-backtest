# 批量回测功能使用指南

## 🎯 功能概述

批量回测功能允许你一次性对多只股票进行回测，快速筛选出表现最好的股票，节省大量手动操作时间。

---

## 🚀 快速使用

### 1. 选择回测模式

在侧边栏找到 **"📋 回测模式"**，选择 **"批量回测"**

### 2. 输入股票代码列表

在 **"股票代码列表"** 文本框中，每行输入一个股票代码：

```
000001
000002
600519
601318
```

**提示**：
- 每行一个代码
- 支持A股、港股、美股、可转债等（根据你选择的数据源和市场）
- 代码数量不限，但建议一次不超过100只（考虑执行时间）

### 3. 配置回测参数

- 选择策略（双均线、布林带、波段等）
- 设置回测时间区间
- 调整策略参数

### 4. 开始回测

点击 **🚀 开始回测** 按钮，系统会：
- 显示进度条
- 逐个股票执行回测
- 自动跳过无效代码

---

## 📊 结果展示

### 汇总统计

回测完成后会显示：
- **平均收益率**：所有股票的平均策略收益
- **最佳收益**：收益最高的股票
- **最差收益**：收益最低的股票
- **胜率中位数**：所有股票胜率的中位数

### 详细结果表格

表格包含每只股票的：
- 股票代码
- 策略收益率
- 基准收益率（买入持有）
- 超额收益（策略 - 基准）
- 胜率
- 交易次数
- 最终资产

**排序**：默认按策略收益率降序排列，最好的在最上面。

### 可视化分析

**1. 收益率分布**
- 直方图显示所有股票的收益分布
- 红色虚线表示平均收益率

**2. Top 10 股票**
- 横向柱状图显示收益最高的10只股票

### 下载结果

点击 **📥 下载完整结果 (CSV)** 按钮，可以下载包含所有回测结果的CSV文件，方便后续分析。

---

## 💡 使用示例

### 示例1：筛选白马股

```
# 选择：Tushare (A股) + 批量回测
# 输入代码：
600519  # 贵州茅台
000858  # 五粮液
600276  # 恒瑞医药
601318  # 中国平安
000333  # 美的集团

# 策略：波段策略（快反应）
# 回测区间：最近3年
```

**目标**：找出哪只白马股在该策略下表现最好

### 示例2：同行业对比

```
# 选择：Tushare (A股) + 批量回测
# 输入代码：（银行股）
601398  # 工商银行
601939  # 建设银行
601988  # 中国银行
601288  # 农业银行
600036  # 招商银行

# 策略：双均线策略
# 回测区间：最近1年
```

**目标**：对比同行业不同公司的策略表现

### 示例3：美股科技股筛选

```
# 选择：YFinance (美股) + 批量回测
# 输入代码：
AAPL    # 苹果
MSFT    # 微软
GOOGL   # 谷歌
TSLA    # 特斯拉
NVDA    # 英伟达
META    # Meta

# 策略：布林带突破
# 回测区间：最近2年
```

---

## ⚠️ 注意事项

### 1. 数据获取

- **第一次运行较慢**：需要从数据源拉取所有股票的数据
- **后续运行较快**：数据会自动缓存，第二次运行速度显著提升
- **无效代码自动跳过**：如果某个代码无法获取数据，会记录在失败列表中

### 2. 执行时间

- **10只股票**：约 10-30秒（有缓存）
- **50只股票**：约 1-2分钟（有缓存）
- **100只股票**：约 2-5分钟（有缓存）

**建议**：
- 如果股票较多，建议分批回测
- 利用缓存机制，相同参数的重复运行会很快

### 3. 代码格式

不同数据源和市场的代码格式：

| 数据源 | 市场 | 代码格式 | 示例 |
|--------|------|----------|------|
| Tushare | A股 | 6位数字 | 000001, 600519 |
| Tushare | 可转债 | 6位数字 | 128039, 113050 |
| AKShare | A股 | 6位数字 | 000001, 600519 |
| AKShare | 港股 | 5位数字 | 00700, 09988 |
| YFinance | 美股 | 大写字母 | AAPL, TSLA |
| YFinance | 港股 | 数字+.HK | 0700.HK, 9988.HK |
| YFinance | 加密货币 | 代码-USD | BTC-USD, ETH-USD |

---

## 🎓 最佳实践

### 1. 策略筛选流程

```
第一步：大范围初筛
- 批量回测 100只 候选股票
- 使用简单策略（如双均线）
- 筛选出收益率 Top 20

第二步：精细优化
- 对 Top 20 进行单只回测
- 调整策略参数
- 查看详细图表

第三步：多策略验证
- 对最终候选股
- 尝试不同策略
- 选择稳定性最好的
```

### 2. 参数优化策略

- **第一次运行**：使用默认参数，快速了解大致情况
- **第二次运行**：针对 Top 股票，调整参数优化
- **对比分析**：下载 CSV 结果，用 Excel 做更深入分析

### 3. 结果解读

**关注指标**：
1. **超额收益**：策略收益 > 基准收益（说明策略有效）
2. **胜率**：>50% 说明盈利交易占多数
3. **交易次数**：过多可能导致手续费高，过少可能没充分利用机会

**避坑指南**：
- ❌ 不要只看策略收益，要看超额收益
- ❌ 不要只关注一只股票，要看整体分布
- ❌ 不要忽视交易次数，考虑实际操作可行性

---

## 🔧 故障排除

### 问题1：部分股票回测失败

**原因**：代码错误或该时期无数据
**解决**：查看失败详情，确认代码正确性

### 问题2：回测速度很慢

**原因**：第一次运行需要下载数据
**解决**：
- 耐心等待（会显示进度）
- 数据会自动缓存，第二次运行会很快
- 可以使用优化工具清理旧缓存：`python tools/auto_optimize_cache.py --execute`

### 问题3：内存不足

**原因**：同时处理太多股票
**解决**：减少批量数量，分批处理

---

## 📝 输入格式示例

### 格式1：纯代码（推荐）

```
000001
000002
600519
```

### 格式2：带空行（会自动忽略）

```
000001

000002

600519
```

### 格式3：带注释（手动删除注释）

```
000001  
000002  
600519  
```

**注意**：目前不支持行内注释，请只输入纯代码。

---

## 🎉 总结

批量回测功能适合：
- ✅ 快速筛选大量股票
- ✅ 同行业对比分析
- ✅ 策略参数优化前的初步验证
- ✅ 建立自选股池

配合单只股票回测使用：
1. 批量回测筛选 → 找出 Top 股票
2. 单只回测深入 → 查看详细图表和交易记录
3. 参数优化 → 针对性调整

祝你找到优秀的交易机会！📈
