# æ•°æ®ç¼“å­˜æ¨¡å—

## ğŸ“¦ æ–°å¢æ–‡ä»¶åˆ—è¡¨

```
quant-backtest/
â”œâ”€â”€ cache_manager.py              # ç¼“å­˜ç®¡ç†å™¨æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ cached_data_source.py         # æ•°æ®æºç¼“å­˜è£…é¥°å™¨
â”œâ”€â”€ cache/                        # ç¼“å­˜æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ config.json              # ç¼“å­˜é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ data/                    # æ•°æ®æ–‡ä»¶å­˜å‚¨
â”‚   â”œâ”€â”€ metadata/                # å…ƒæ•°æ®å­˜å‚¨
â”‚   â”‚   â””â”€â”€ cache_index.json    # ç¼“å­˜ç´¢å¼•
â”‚   â””â”€â”€ logs/                    # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ cache_tool.py            # ç¼“å­˜ç®¡ç†å‘½ä»¤è¡Œå·¥å…·
â”‚   â””â”€â”€ test_cache.py            # ç¼“å­˜åŠŸèƒ½æµ‹è¯•è„šæœ¬
â””â”€â”€ docs/
    â””â”€â”€ æ•°æ®ç¼“å­˜ä½¿ç”¨æŒ‡å—.md        # è¯¦ç»†ä½¿ç”¨æ–‡æ¡£
```

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### 1. cache_manager.py
ç¼“å­˜ç®¡ç†å™¨æ ¸å¿ƒæ¨¡å—ï¼ŒåŒ…å«4ä¸ªä¸»è¦ç±»ï¼š

- **CacheManager**: ç¼“å­˜ç®¡ç†å™¨ä¸»ç±»ï¼Œç»Ÿä¸€ç¼“å­˜å…¥å£
- **CacheIndex**: ç´¢å¼•ç®¡ç†å™¨ï¼Œç®¡ç† cache_index.json
- **CacheStorage**: å­˜å‚¨å±‚ï¼Œè´Ÿè´£æ–‡ä»¶è¯»å†™ï¼ˆParquet/CSVï¼‰
- **CachePolicy**: ç­–ç•¥ç®¡ç†å™¨ï¼Œå¤„ç†TTLå’Œæ¸…ç†ç­–ç•¥

### 2. cached_data_source.py
æ•°æ®æºç¼“å­˜è£…é¥°å™¨ï¼Œä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ï¼š

- **CachedDataSourceWrapper**: åŒ…è£…åŸæœ‰æ•°æ®æºï¼Œæ·»åŠ ç¼“å­˜åŠŸèƒ½
- **create_cached_data_source()**: å·¥å‚å‡½æ•°ï¼Œåˆ›å»ºå¸¦ç¼“å­˜çš„æ•°æ®æº
- **get_cached_stock_data()**: ä¾¿æ·å‡½æ•°ï¼Œä¸€è¡Œä»£ç è·å–å¸¦ç¼“å­˜çš„æ•°æ®

### 3. cache/config.json
ç¼“å­˜é…ç½®æ–‡ä»¶ï¼Œå¯é…ç½®ï¼š
- ç¼“å­˜å®¹é‡é™åˆ¶
- TTLè§„åˆ™
- æ¸…ç†ç­–ç•¥
- å­˜å‚¨æ ¼å¼
- æ—¥å¿—è®¾ç½®

### 4. test/cache_tool.py
å‘½ä»¤è¡Œç®¡ç†å·¥å…·ï¼Œæä¾›ï¼š
1. æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
2. åˆ—å‡ºæ‰€æœ‰ç¼“å­˜
3. æŸ¥çœ‹ç¼“å­˜è¯¦æƒ…
4. æ¸…ç†è¿‡æœŸç¼“å­˜
5. åˆ é™¤æŒ‡å®šç¼“å­˜
6. æ¸…ç©ºæ‰€æœ‰ç¼“å­˜

### 5. test/test_cache.py
è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š
- åŸºæœ¬ç¼“å­˜åŠŸèƒ½
- ç¼“å­˜ç»Ÿè®¡
- æ—¥æœŸèŒƒå›´æŸ¥è¯¢
- ä¸åŒå¸‚åœºéš”ç¦»
- ä¾¿æ·å‡½æ•°

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### æœ€ç®€å•çš„æ–¹å¼ï¼š

```python
from cached_data_source import get_cached_stock_data
import datetime

# ä¸€è¡Œä»£ç ï¼Œè‡ªåŠ¨ç¼“å­˜
df = get_cached_stock_data(
    code='000001',
    start_date=datetime.date(2024, 1, 1),
    end_date=datetime.date(2024, 12, 31),
    market='Aè‚¡',
    source_type='akshare'
)
```

### é›†æˆåˆ°ç°æœ‰ä»£ç ï¼š

åªéœ€æ›¿æ¢ä¸€è¡Œï¼š

```python
# åŸæ¥
from data_source import DataSourceFactory
data_source = DataSourceFactory.create_data_source('akshare')

# ç°åœ¨ï¼ˆæ·»åŠ ç¼“å­˜ï¼‰
from cached_data_source import create_cached_data_source
data_source = create_cached_data_source('akshare', cache_enabled=True)

# å…¶ä»–ä»£ç ä¸å˜
df = data_source.fetch_data(code, start_date, end_date, market='Aè‚¡')
```

## ğŸ“š è¯¦ç»†æ–‡æ¡£

è¯·æŸ¥çœ‹ï¼š[docs/æ•°æ®ç¼“å­˜ä½¿ç”¨æŒ‡å—.md](../docs/æ•°æ®ç¼“å­˜ä½¿ç”¨æŒ‡å—.md)

åŒ…å«ï¼š
- å®Œæ•´åŠŸèƒ½è¯´æ˜
- é…ç½®è¯¦è§£
- ä½¿ç”¨ç¤ºä¾‹
- æœ€ä½³å®è·µ
- å¸¸è§é—®é¢˜

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
python test/test_cache.py

# ç®¡ç†ç¼“å­˜
python test/cache_tool.py
```

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### ç¼“å­˜é”®æ ¼å¼
```
{æ•°æ®æº}_{å¸‚åœº}_{ä»£ç }_{å¼€å§‹æ—¥æœŸ}_{ç»“æŸæ—¥æœŸ}_{æ—¶é—´ç²’åº¦}

ç¤ºä¾‹:
- akshare_a_stock_000001_20240101_20241231_1d
- yfinance_crypto_BTC-USD_20240601_20241231_1h
```

### å­˜å‚¨æ ¼å¼
- **Parquet**: é«˜å‹ç¼©ç‡ã€å¿«é€Ÿè¯»å–ï¼ˆæ¨èï¼‰
- **CSV**: å¯è¯»æ€§å¥½ï¼ˆå¤‡é€‰ï¼‰

### TTLç­–ç•¥
- å†å²æ•°æ®ï¼šæ°¸ä¸è¿‡æœŸ
- è¿‘æœŸæ•°æ®ï¼š7å¤©
- å®æ—¶æ•°æ®ï¼š1å°æ—¶
- åŠ å¯†è´§å¸ï¼š30åˆ†é’Ÿ

### æ¸…ç†ç­–ç•¥
- LRUï¼ˆæœ€å°‘æœ€è¿‘ä½¿ç”¨ï¼‰
- å®¹é‡é™åˆ¶è‡ªåŠ¨æ¸…ç†
- æ‰‹åŠ¨æ¸…ç†å·¥å…·

## ğŸ’¡ ä¼˜åŠ¿

1. **æ€§èƒ½æå‡**: 30-300å€é€Ÿåº¦æå‡
2. **é™ä½APIå‹åŠ›**: å‡å°‘é‡å¤è¯·æ±‚
3. **ç¦»çº¿å¯ç”¨**: æœ‰ç¼“å­˜çš„æ•°æ®å¯ç¦»çº¿ä½¿ç”¨
4. **é€æ˜é›†æˆ**: ä¸å½±å“ç°æœ‰ä»£ç 
5. **æ™ºèƒ½ç®¡ç†**: è‡ªåŠ¨è¿‡æœŸã€è‡ªåŠ¨æ¸…ç†

## ğŸ”§ ä¾èµ–

éœ€è¦å®‰è£… pyarrow ä»¥æ”¯æŒ Parquet æ ¼å¼ï¼š

```bash
pip install pyarrow
```

## ğŸ“ ç‰ˆæœ¬å†å²

- **v1.0.0** (2026-02-13)
  - åˆå§‹ç‰ˆæœ¬
  - åŸºæœ¬ç¼“å­˜åŠŸèƒ½
  - TTLç­–ç•¥
  - ç®¡ç†å·¥å…·
  - æµ‹è¯•è„šæœ¬

---

**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ  
**æ–‡æ¡£**: docs/æ•°æ®ç¼“å­˜ä½¿ç”¨æŒ‡å—.md
