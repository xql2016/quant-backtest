# æ•°æ®ç¼“å­˜åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“Œ åŠŸèƒ½æ¦‚è¿°

æ•°æ®ç¼“å­˜æ¨¡å—ä¸ºé‡åŒ–å›æµ‹ç³»ç»Ÿæä¾›æœ¬åœ°æ•°æ®ç¼“å­˜åŠŸèƒ½ï¼Œå‡å°‘å¯¹ä¸ç¨³å®šAPIçš„ä¾èµ–ï¼Œæå‡æ•°æ®è·å–é€Ÿåº¦ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. ä¸‰å±‚ç¼“å­˜æ¶æ„
```
Streamlitå†…å­˜ç¼“å­˜ (è¿è¡Œæ—¶) â†’ å¿«é€Ÿè®¿é—®
        â†“
æœ¬åœ°æ–‡ä»¶ç¼“å­˜ (æŒä¹…åŒ–) â†’ è·¨ä¼šè¯å¤ç”¨
        â†“
è¿œç¨‹API (ç½‘ç»œè¯·æ±‚) â†’ æ•°æ®æº
```

### 2. æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- âœ… **å®Œå…¨å‘½ä¸­**ï¼šæŸ¥è¯¢èŒƒå›´åœ¨å•ä¸ªç¼“å­˜å†… â†’ ç›´æ¥ä½¿ç”¨
- âš ï¸ **éƒ¨åˆ†å‘½ä¸­**ï¼šæŸ¥è¯¢èŒƒå›´è·¨å¤šä¸ªç¼“å­˜ â†’ é‡æ–°è·å–ï¼ˆMVPç‰ˆæœ¬ï¼‰
- âŒ **æœªå‘½ä¸­**ï¼šæ— ç¼“å­˜ â†’ è·å–å¹¶ä¿å­˜

### 3. TTLè¿‡æœŸç­–ç•¥
- **å†å²æ•°æ®** (ç»“æŸæ—¥æœŸ > 7å¤©å‰)ï¼šæ°¸ä¸è¿‡æœŸ
- **è¿‘æœŸæ•°æ®** (ç»“æŸæ—¥æœŸåœ¨1-7å¤©å‰)ï¼š7å¤©åè¿‡æœŸ
- **æœ€æ–°æ•°æ®** (ç»“æŸæ—¥æœŸæ˜¯ä»Šå¤©)ï¼š1å°æ—¶åè¿‡æœŸ
- **åŠ å¯†è´§å¸å®æ—¶æ•°æ®**ï¼š30åˆ†é’Ÿåè¿‡æœŸ

### 4. æ•°æ®å­˜å‚¨
- **æ ¼å¼**ï¼šParquet (é«˜å‹ç¼©ç‡ã€å¿«é€Ÿè¯»å–)
- **å¤‡é€‰**ï¼šCSV (å¯è¯»æ€§å¥½)
- **å‹ç¼©**ï¼šSnappyç®—æ³•

## ğŸ“ ç›®å½•ç»“æ„

```
quant-backtest/
â”œâ”€â”€ cache/                              # ç¼“å­˜æ ¹ç›®å½•
â”‚   â”œâ”€â”€ config.json                    # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ data/                          # æ•°æ®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ akshare/                   # AKShareæ•°æ®æº
â”‚   â”‚   â”‚   â”œâ”€â”€ a_stock/              # Aè‚¡
â”‚   â”‚   â”‚   â”œâ”€â”€ hk_stock/             # æ¸¯è‚¡
â”‚   â”‚   â”‚   â”œâ”€â”€ us_stock/             # ç¾è‚¡
â”‚   â”‚   â”‚   â””â”€â”€ convertible_bond/     # å¯è½¬å€º
â”‚   â”‚   â”œâ”€â”€ yfinance/                  # YFinanceæ•°æ®æº
â”‚   â”‚   â”‚   â”œâ”€â”€ stock_1d/             # è‚¡ç¥¨æ—¥çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ crypto_1h/            # åŠ å¯†è´§å¸1å°æ—¶
â”‚   â”‚   â”‚   â””â”€â”€ crypto_4h/            # åŠ å¯†è´§å¸4å°æ—¶
â”‚   â”‚   â””â”€â”€ tushare/                   # Tushareæ•°æ®æº
â”‚   â”‚       â”œâ”€â”€ a_stock/              # Aè‚¡
â”‚   â”‚       â””â”€â”€ convertible_bond/     # å¯è½¬å€º
â”‚   â”œâ”€â”€ metadata/                      # å…ƒæ•°æ®
â”‚   â”‚   â””â”€â”€ cache_index.json          # ç¼“å­˜ç´¢å¼•
â”‚   â””â”€â”€ logs/                          # æ—¥å¿—
â”‚       â””â”€â”€ cache_access.log          # è®¿é—®æ—¥å¿—
â”œâ”€â”€ cache_manager.py                   # ç¼“å­˜ç®¡ç†å™¨
â”œâ”€â”€ cached_data_source.py              # ç¼“å­˜è£…é¥°å™¨
â””â”€â”€ test/
    â”œâ”€â”€ cache_tool.py                  # ç¼“å­˜ç®¡ç†å·¥å…·
    â””â”€â”€ test_cache.py                  # ç¼“å­˜æµ‹è¯•è„šæœ¬
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1ï¼šä½¿ç”¨ç¼“å­˜è£…é¥°å™¨ï¼ˆæ¨èï¼‰

```python
from cached_data_source import create_cached_data_source
import datetime

# åˆ›å»ºå¸¦ç¼“å­˜çš„æ•°æ®æº
data_source = create_cached_data_source('akshare', cache_enabled=True)

# è·å–æ•°æ®ï¼ˆè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ï¼‰
df = data_source.fetch_data(
    code='000001',
    start_date=datetime.date(2024, 1, 1),
    end_date=datetime.date(2024, 12, 31),
    market='Aè‚¡'
)

# ç¬¬ä¸€æ¬¡ï¼šä»APIè·å– + ä¿å­˜åˆ°ç¼“å­˜
# ç¬¬äºŒæ¬¡ï¼šç›´æ¥ä»ç¼“å­˜è¯»å–ï¼ˆç§’çº§å“åº”ï¼‰
```

### æ–¹æ³•2ï¼šä½¿ç”¨ä¾¿æ·å‡½æ•°

```python
from cached_data_source import get_cached_stock_data
import datetime

# ä¸€è¡Œä»£ç è·å–å¸¦ç¼“å­˜çš„æ•°æ®
df = get_cached_stock_data(
    code='000001',
    start_date=datetime.date(2024, 1, 1),
    end_date=datetime.date(2024, 12, 31),
    market='Aè‚¡',
    source_type='akshare',
    cache_enabled=True
)
```

### æ–¹æ³•3ï¼šé›†æˆåˆ°ç°æœ‰ä»£ç 

å¦‚æœä½ å·²æœ‰ä½¿ç”¨ `DataSourceFactory` çš„ä»£ç ï¼Œåªéœ€ç®€å•æ›¿æ¢ï¼š

**åŸä»£ç ï¼š**
```python
from data_source import DataSourceFactory

data_source = DataSourceFactory.create_data_source('akshare')
df = data_source.fetch_data(code, start_date, end_date, market='Aè‚¡')
```

**æ–°ä»£ç ï¼ˆå¸¦ç¼“å­˜ï¼‰ï¼š**
```python
from cached_data_source import create_cached_data_source

data_source = create_cached_data_source('akshare', cache_enabled=True)
df = data_source.fetch_data(code, start_date, end_date, market='Aè‚¡')
```

## ğŸ”§ é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ï¼š`cache/config.json`

```json
{
  "cache_settings": {
    "enabled": true,              // æ˜¯å¦å¯ç”¨ç¼“å­˜
    "max_size_mb": 1024,          // æœ€å¤§ç¼“å­˜å®¹é‡ (MB)
    "default_ttl_hours": 168,     // é»˜è®¤TTL (å°æ—¶)
    "clean_on_startup": false,    // å¯åŠ¨æ—¶æ˜¯å¦æ¸…ç†
    "compression_level": "default" // å‹ç¼©çº§åˆ«
  },
  "ttl_rules": {
    "historical_data_ttl": -1,           // å†å²æ•°æ®TTL (-1=æ°¸ä¸è¿‡æœŸ)
    "recent_data_days": 7,               // è¿‘æœŸæ•°æ®å¤©æ•°é˜ˆå€¼
    "recent_data_ttl_hours": 168,        // è¿‘æœŸæ•°æ®TTL (å°æ—¶)
    "realtime_data_ttl_minutes": 60,     // å®æ—¶æ•°æ®TTL (åˆ†é’Ÿ)
    "crypto_ttl_minutes": 30             // åŠ å¯†è´§å¸TTL (åˆ†é’Ÿ)
  },
  "cleanup_policy": {
    "strategy": "hybrid",                // æ¸…ç†ç­–ç•¥
    "unused_days_threshold": 30,         // æœªä½¿ç”¨å¤©æ•°é˜ˆå€¼
    "min_access_count": 3,               // æœ€å°è®¿é—®æ¬¡æ•°
    "auto_cleanup_interval_hours": 24    // è‡ªåŠ¨æ¸…ç†é—´éš”
  },
  "storage_format": {
    "format": "parquet",          // å­˜å‚¨æ ¼å¼
    "compression": "snappy",      // å‹ç¼©ç®—æ³•
    "fallback_format": "csv"      // å¤‡é€‰æ ¼å¼
  },
  "logging": {
    "enabled": true,              // æ˜¯å¦å¯ç”¨æ—¥å¿—
    "log_level": "INFO",          // æ—¥å¿—çº§åˆ«
    "log_access": true,           // æ˜¯å¦è®°å½•è®¿é—®æ—¥å¿—
    "log_file": "cache/logs/cache_access.log"  // æ—¥å¿—æ–‡ä»¶è·¯å¾„
  }
}
```

## ğŸ› ï¸ ç¼“å­˜ç®¡ç†å·¥å…·

### å‘½ä»¤è¡Œå·¥å…·

```bash
# å¯åŠ¨ç¼“å­˜ç®¡ç†å·¥å…·
python test/cache_tool.py
```

**åŠŸèƒ½èœå•ï¼š**
1. æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
2. åˆ—å‡ºæ‰€æœ‰ç¼“å­˜
3. æŸ¥çœ‹æŒ‡å®šä»£ç çš„ç¼“å­˜è¯¦æƒ…
4. æ¸…ç†è¿‡æœŸ/å†—ä½™ç¼“å­˜
5. åˆ é™¤æŒ‡å®šä»£ç çš„ç¼“å­˜
6. æ¸…ç©ºæ‰€æœ‰ç¼“å­˜

### ç¼–ç¨‹æ–¹å¼

```python
from cache_manager import CacheManager

# åˆ›å»ºç¼“å­˜ç®¡ç†å™¨
cache_manager = CacheManager()

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
stats = cache_manager.get_statistics()
print(f"ç¼“å­˜æ€»æ•°: {stats['total_entries']}")
print(f"ç¼“å­˜å¤§å°: {stats['total_size_mb']} MB")

# æ¸…ç†ç¼“å­˜
cache_manager.cleanup_cache()

# åˆ é™¤æŒ‡å®šç¼“å­˜
cache_manager.delete_cache('akshare_a_stock_000001_20240101_20241231_1d')

# æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
cache_manager.clear_all_cache()
```

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šAè‚¡æ—¥çº¿æ•°æ®ç¼“å­˜

```python
from cached_data_source import create_cached_data_source
import datetime

# åˆ›å»ºæ•°æ®æº
data_source = create_cached_data_source('tushare', token='your_token')

# ç¬¬ä¸€æ¬¡è·å–ï¼ˆçº¦5-10ç§’ï¼‰
df = data_source.fetch_data(
    '000001',
    datetime.date(2024, 1, 1),
    datetime.date(2024, 12, 31),
    market='Aè‚¡'
)
# è¾“å‡º: ğŸŒ ä»APIè·å–æ•°æ®: 000001
#       ğŸ’¾ æ•°æ®å·²ç¼“å­˜: 000001

# ç¬¬äºŒæ¬¡è·å–ï¼ˆ< 0.1ç§’ï¼‰
df = data_source.fetch_data(
    '000001',
    datetime.date(2024, 1, 1),
    datetime.date(2024, 12, 31),
    market='Aè‚¡'
)
# è¾“å‡º: ğŸ¯ ä½¿ç”¨ç¼“å­˜æ•°æ®: 000001 (243 æ¡è®°å½•)
```

### ç¤ºä¾‹2ï¼šåŠ å¯†è´§å¸å°æ—¶çº¿ç¼“å­˜

```python
from cached_data_source import create_cached_data_source
import datetime

data_source = create_cached_data_source('yfinance')

# ç¼“å­˜BTCçš„1å°æ—¶Kçº¿
df = data_source.fetch_data(
    'BTC-USD',
    datetime.date(2024, 6, 1),
    datetime.date(2024, 6, 30),
    market='crypto',
    interval='1h'
)

# åç»­è®¿é—®ç›´æ¥ä»ç¼“å­˜è¯»å–ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
```

### ç¤ºä¾‹3ï¼šæ—¥æœŸèŒƒå›´è¿‡æ»¤

```python
from cached_data_source import create_cached_data_source
import datetime

data_source = create_cached_data_source('akshare')

# ç¼“å­˜å¤§èŒƒå›´æ•°æ®
df_large = data_source.fetch_data(
    '000001',
    datetime.date(2024, 1, 1),
    datetime.date(2024, 12, 31),
    market='Aè‚¡'
)

# æŸ¥è¯¢å°èŒƒå›´ï¼ˆä»ç¼“å­˜ä¸­è¿‡æ»¤ï¼‰
df_small = data_source.fetch_data(
    '000001',
    datetime.date(2024, 6, 1),
    datetime.date(2024, 6, 30),
    market='Aè‚¡'
)
# è¾“å‡º: ğŸ¯ ä½¿ç”¨ç¼“å­˜æ•°æ®: 000001 (20 æ¡è®°å½•)
```

## ğŸ§ª æµ‹è¯•ç¼“å­˜åŠŸèƒ½

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python test/test_cache.py
```

æµ‹è¯•å†…å®¹ï¼š
- âœ… åŸºæœ¬ç¼“å­˜åŠŸèƒ½
- âœ… ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
- âœ… æ—¥æœŸèŒƒå›´æŸ¥è¯¢
- âœ… ä¸åŒå¸‚åœºçš„ç¼“å­˜éš”ç¦»
- âœ… ä¾¿æ·å‡½æ•°

## âš¡ æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | æå‡ |
|------|--------|--------|------|
| Aè‚¡æ—¥çº¿ (1å¹´) | 3-10ç§’ | < 0.1ç§’ | 30-100å€ |
| åŠ å¯†è´§å¸å°æ—¶çº¿ (1æœˆ) | 5-15ç§’ | < 0.2ç§’ | 25-75å€ |
| å¯è½¬å€ºæ—¥çº¿ (1å¹´) | 5-30ç§’ | < 0.1ç§’ | 50-300å€ |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®ç¼“å­˜å®¹é‡
```json
{
  "cache_settings": {
    "max_size_mb": 1024  // æ ¹æ®ç£ç›˜ç©ºé—´è°ƒæ•´
  }
}
```

### 2. å®šæœŸæ¸…ç†ç¼“å­˜
```python
# æ¯å‘¨æ¸…ç†ä¸€æ¬¡
cache_manager.cleanup_cache()
```

### 3. ç¼“å­˜é¢„çƒ­ï¼ˆå¯é€‰ï¼‰
```python
# é¢„å…ˆç¼“å­˜å¸¸ç”¨æ•°æ®
codes = ['000001', '000002', '600519']
for code in codes:
    data_source.fetch_data(code, start_date, end_date, market='Aè‚¡')
```

### 4. ç¦ç”¨ç¼“å­˜çš„åœºæ™¯
```python
# éœ€è¦å®æ—¶æ•°æ®æ—¶
data_source = create_cached_data_source('akshare', cache_enabled=False)
```

## â“ å¸¸è§é—®é¢˜

### Q1: ç¼“å­˜å ç”¨å¤ªå¤šç©ºé—´æ€ä¹ˆåŠï¼Ÿ
```python
# æ–¹æ³•1: è°ƒæ•´æœ€å¤§å®¹é‡
# ä¿®æ”¹ cache/config.json ä¸­çš„ max_size_mb

# æ–¹æ³•2: æ‰‹åŠ¨æ¸…ç†
python test/cache_tool.py  # é€‰æ‹©é€‰é¡¹4
```

### Q2: å¦‚ä½•å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼Ÿ
```python
# æ–¹æ³•1: åˆ é™¤æŒ‡å®šç¼“å­˜
cache_manager.delete_cache(cache_key)

# æ–¹æ³•2: ç¦ç”¨ç¼“å­˜è·å–æ–°æ•°æ®
data_source = create_cached_data_source('akshare', cache_enabled=False)
```

### Q3: ç¼“å­˜æ•°æ®ä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ
```python
# æ¸…ç©ºæ‰€æœ‰ç¼“å­˜é‡æ–°è·å–
cache_manager.clear_all_cache()
```

### Q4: å¦‚ä½•æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡ï¼Ÿ
```python
# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
# cache/logs/cache_access.log
```

## ğŸ”„ æœªæ¥ä¼˜åŒ–æ–¹å‘

- [ ] æ”¯æŒå¤šç¼“å­˜åˆå¹¶ï¼ˆéƒ¨åˆ†å‘½ä¸­ä¼˜åŒ–ï¼‰
- [ ] æ”¯æŒå¢é‡æ›´æ–°ï¼ˆåªè·å–ç¼ºå¤±éƒ¨åˆ†ï¼‰
- [ ] ç¼“å­˜é¢„çƒ­åŠŸèƒ½
- [ ] Webç•Œé¢ç®¡ç†
- [ ] ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- [ ] åˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æŸ¥çœ‹æ—¥å¿—ï¼š`cache/logs/cache_access.log`
- æ£€æŸ¥é…ç½®ï¼š`cache/config.json`
- è¿è¡Œæµ‹è¯•ï¼š`python test/test_cache.py`
- ç®¡ç†å·¥å…·ï¼š`python test/cache_tool.py`

---

**ç‰ˆæœ¬ï¼š** 1.0.0  
**æœ€åæ›´æ–°ï¼š** 2026-02-13  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ
