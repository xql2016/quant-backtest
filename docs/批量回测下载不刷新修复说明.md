# 批量回测CSV下载不刷新页面 - 修复说明

## 问题描述

用户反馈批量回测功能存在以下问题：
1. **点击下载CSV后页面会跳转到初始化页面**
2. **CSV文件用Excel打开后中文显示乱码**

## 问题原因

### 问题1：页面刷新
Streamlit的 `st.download_button` 点击后会触发页面重新渲染。由于批量回测结果存储在局部变量中，在 `if run_btn:` 块内，页面刷新后 `run_btn` 为 `False`，导致结果丢失，页面回到初始状态。

### 问题2：中文乱码  
CSV文件使用UTF-8编码，但Excel默认使用系统编码（如GB2312）打开CSV文件，导致中文显示为乱码。

## 解决方案

### 1. 使用 session_state 持久化数据

**核心思路**：将批量回测结果保存到 `st.session_state`，使其在页面刷新后仍然可用。

**实现步骤**：

#### 步骤1：初始化 session_state
```python
# 在 if run_btn: 之前初始化
if 'batch_results' not in st.session_state:
    st.session_state.batch_results = None
if 'batch_trades' not in st.session_state:
    st.session_state.batch_trades = None
if 'batch_failed' not in st.session_state:
    st.session_state.batch_failed = None
if 'batch_metadata' not in st.session_state:
    st.session_state.batch_metadata = None
```

#### 步骤2：保存回测结果
在批量回测完成后（`progress_bar.empty()` 之后）：
```python
# 保存结果到 session_state
st.session_state.batch_results = results
st.session_state.batch_trades = all_trades
st.session_state.batch_failed = failed_codes
st.session_state.batch_metadata = {
    'data_source': data_source_name,
    'market': market_type,
    'strategy': selected_strategy
}
```

#### 步骤3：独立的显示逻辑
在 `if run_btn:` 块**之外**添加显示逻辑，使其不依赖按钮状态：
```python
# 在文件末尾，侧边栏代码之后
if batch_mode == "批量回测" and st.session_state.batch_results is not None:
    # 从 session_state 读取数据
    results = st.session_state.batch_results
    all_trades = st.session_state.batch_trades
    failed_codes = st.session_state.batch_failed
    metadata = st.session_state.batch_metadata
    
    # 显示结果（表格、图表、下载按钮等）
    # ...
```

### 2. 修复CSV中文乱码

使用 `utf-8-sig` 编码（UTF-8 with BOM），Excel会自动识别：

```python
# 汇总结果
csv_summary = results_df.to_csv(index=False, encoding='utf-8-sig')

# 交易记录
csv_trades = trades_df.to_csv(index=False, encoding='utf-8-sig')
```

**UTF-8-sig 说明**：
- 添加BOM（Byte Order Mark）标记：`EF BB BF`
- Excel在打开CSV时会识别此标记，自动使用UTF-8解码
- 不影响其他编辑器（VS Code、Sublime等）的正常显示

## 修改位置

### run_main.py 修改摘要

1. **第294-306行**：初始化 session_state
2. **第384-395行**：保存批量回测结果到 session_state
3. **第398-496行**：删除错误放置的批量回测显示代码
4. **第643-758行**：添加独立的批量回测结果显示逻辑
5. **所有下载按钮**：CSV编码改为 `utf-8-sig`

## 效果验证

### 功能验证清单
- [x] Python语法检查通过
- [ ] 批量回测正常执行
- [ ] 回测结果正常显示
- [ ] 点击"下载汇总结果"后页面不刷新
- [ ] 点击"下载交易记录"后页面不刷新
- [ ] CSV文件用Excel打开中文正常显示
- [ ] 切换到其他模式后批量结果消失

### 测试步骤
1. 启动应用：`streamlit run run_main.py`
2. 选择"批量回测"模式
3. 输入多只股票代码（如：`000001`、`000002`、`000003`）
4. 点击"开始回测"
5. 等待回测完成，查看结果
6. **关键测试**：点击"下载汇总结果 (CSV)"
   - 预期：文件正常下载，页面保持在结果页，不跳转
7. **关键测试**：点击"下载交易记录 (CSV)"
   - 预期：文件正常下载，页面保持不变
8. 用Excel打开下载的CSV文件
   - 预期：中文正常显示，无乱码

## 技术要点

### Streamlit session_state 特性
- **持久性**：在页面刷新、组件交互后数据不丢失
- **作用域**：仅限当前用户会话
- **生命周期**：用户关闭浏览器tab或刷新页面（F5）后清空

### 下载按钮行为
- `st.download_button` 点击后会触发页面重新渲染
- 使用 `key` 参数确保按钮唯一性
- `use_container_width=True` 提升UI美观度

### 编码最佳实践
- **CSV for Excel**：使用 `utf-8-sig`
- **CSV for 数据分析**：使用 `utf-8`（无BOM）
- **JSON/API**：使用 `utf-8`

## 注意事项

1. **缩进问题**：本次修改特别注意了Python缩进，所有代码块严格遵守4空格缩进规则
2. **变量作用域**：确保 `all_trades`、`failed_codes` 等变量在正确的作用域内使用
3. **兼容性**：不影响单只股票回测功能
4. **性能**：session_state存储大量数据可能影响性能，但对于回测结果（通常<1MB）影响可忽略

## 后续优化建议

1. **添加清除按钮**：允许用户手动清除批量回测结果
2. **结果缓存**：将历史回测结果保存到文件，支持查看历史记录
3. **Excel格式导出**：使用 `openpyxl` 或 `xlsxwriter` 生成真正的 `.xlsx` 文件
4. **进度持久化**：支持中断恢复，大批量回测时更友好

---

**修复完成时间**：2026-02-13  
**修复人员**：AI Assistant  
**测试状态**：语法检查通过 ✅，功能测试待用户验证
