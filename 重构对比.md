# æ¨¡å—åŒ–é‡æ„å‰åå¯¹æ¯”

## ğŸ“Š æ–‡ä»¶ç»“æ„å¯¹æ¯”

### é‡æ„å‰
```
quant/
â””â”€â”€ å¤šç­–ç•¥å¯è§†åŒ–å›æµ‹_å°çº¢ä¹¦20260117.py  (641è¡Œï¼Œæ‰€æœ‰åŠŸèƒ½æ··åœ¨ä¸€èµ·)
```

### é‡æ„å
```
quant/
â”œâ”€â”€ data_source.py                    (350è¡Œï¼Œæ•°æ®æºæ¨¡å—)
â”œâ”€â”€ strategy_backtest.py              (550è¡Œï¼Œç­–ç•¥å›æµ‹æ¨¡å—)
â”œâ”€â”€ å¤šç­–ç•¥å¯è§†åŒ–å›æµ‹_å°çº¢ä¹¦20260117.py (280è¡Œï¼ŒUIå±•ç¤º)
â”œâ”€â”€ ç‹¬ç«‹ä½¿ç”¨ç¤ºä¾‹.py                   (200è¡Œï¼Œä½¿ç”¨ç¤ºä¾‹)
â”œâ”€â”€ test_modules.py                   (180è¡Œï¼Œæµ‹è¯•è„šæœ¬)
â”œâ”€â”€ æ¨¡å—åŒ–é‡æ„è¯´æ˜.md                 (è¯¦ç»†æ–‡æ¡£)
â””â”€â”€ README_æ¨¡å—åŒ–.md                  (å¿«é€ŸæŒ‡å—)
```

---

## ğŸ”„ ä»£ç ç»“æ„å¯¹æ¯”

### 1. æ•°æ®è·å–éƒ¨åˆ†

#### âŒ é‡æ„å‰ï¼ˆæ··ä¹±ï¼‰
```python
# æ‰€æœ‰é€»è¾‘å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œï¼Œéš¾ä»¥æ‰©å±•
@st.cache_data(ttl=3600)
def get_stock_data(code, start, end, market='Aè‚¡'):
    try:
        if market == 'Aè‚¡':
            # 100è¡ŒAè‚¡æ•°æ®è·å–ä»£ç 
        elif market == 'æ¸¯è‚¡':
            # 100è¡Œæ¸¯è‚¡æ•°æ®è·å–ä»£ç 
        elif market == 'ç¾è‚¡':
            # 100è¡Œç¾è‚¡æ•°æ®è·å–ä»£ç 
        # æ— æ³•æ–¹ä¾¿åœ°æ·»åŠ æ–°æ•°æ®æº
    except Exception as e:
        return None
```

#### âœ… é‡æ„åï¼ˆæ¸…æ™°ï¼‰
```python
# æŠ½è±¡åŸºç±»å®šä¹‰æ ‡å‡†æ¥å£
class DataSource(ABC):
    @abstractmethod
    def fetch_data(self, code, start_date, end_date, **kwargs):
        pass

# å…·ä½“å®ç°åˆ†ç¦»
class AKShareDataSource(DataSource):
    def fetch_data(self, code, start_date, end_date, market='Aè‚¡'):
        # æ¸…æ™°çš„å®ç°é€»è¾‘
        pass

# å·¥å‚æ¨¡å¼åˆ›å»º
class DataSourceFactory:
    @staticmethod
    def create_data_source(source_type='akshare', **kwargs):
        # ç»Ÿä¸€åˆ›å»ºå…¥å£
        pass

# æ·»åŠ æ–°æ•°æ®æºåªéœ€ä¸€ä¸ªç±»
class TushareDataSource(DataSource):
    def fetch_data(self, ...):
        pass  # å®ç°å³å¯
```

---

### 2. ç­–ç•¥è®¡ç®—éƒ¨åˆ†

#### âŒ é‡æ„å‰ï¼ˆå†—é•¿ï¼‰
```python
# ä¸»æµç¨‹ä¸­å……æ–¥å¤§é‡if-elifåˆ†æ”¯
if selected_strategy == "MACDè¶‹åŠ¿ç­–ç•¥":
    # 50è¡ŒMACDè®¡ç®—ä»£ç 
    ema_fast = df['close'].ewm(span=params['fast'], adjust=False).mean()
    ema_slow = df['close'].ewm(span=params['slow'], adjust=False).mean()
    df['dif'] = ema_fast - ema_slow
    df['dea'] = df['dif'].ewm(span=params['signal'], adjust=False).mean()
    df['macd_hist'] = (df['dif'] - df['dea']) * 2
    c_buy = (df['dif'].shift(1) < df['dea'].shift(1)) & (df['dif'] > df['dea'])
    c_sell = (df['dif'].shift(1) > df['dea'].shift(1)) & (df['dif'] < df['dea'])
    df.loc[c_buy, 'signal'] = 1
    df.loc[c_sell, 'signal'] = -1

elif selected_strategy == "åŒå‡çº¿ç­–ç•¥(SMA)":
    # 50è¡ŒåŒå‡çº¿è®¡ç®—ä»£ç 
    df['sma_short'] = df['close'].rolling(window=params['short']).mean()
    df['sma_long'] = df['close'].rolling(window=params['long']).mean()
    c_buy = (df['sma_short'].shift(1) < df['sma_long'].shift(1)) & (df['sma_short'] > df['sma_long'])
    c_sell = (df['sma_short'].shift(1) > df['sma_long'].shift(1)) & (df['sma_short'] < df['sma_long'])
    df.loc[c_buy, 'signal'] = 1
    df.loc[c_sell, 'signal'] = -1

elif selected_strategy == "RSIè¶…ä¹°è¶…å–":
    # 50è¡ŒRSIè®¡ç®—ä»£ç 
    ...

# ... æ›´å¤šç­–ç•¥ï¼Œä»£ç è¶Šæ¥è¶Šé•¿
```

#### âœ… é‡æ„åï¼ˆä¼˜é›…ï¼‰
```python
# æŠ½è±¡åŸºç±»å®šä¹‰æ¥å£
class Strategy(ABC):
    @abstractmethod
    def calculate_signals(self, df):
        pass

# æ¯ä¸ªç­–ç•¥ç‹¬ç«‹å®ç°
class MACDStrategy(Strategy):
    def calculate_signals(self, df):
        # æ¸…æ™°çš„MACDé€»è¾‘
        pass

class DoubleSMAStrategy(Strategy):
    def calculate_signals(self, df):
        # æ¸…æ™°çš„åŒå‡çº¿é€»è¾‘
        pass

# ä¸»æµç¨‹å˜å¾—ç®€æ´
strategy = StrategyFactory.create_strategy(selected_strategy, params)
result = engine.run(df, strategy)
```

---

### 3. å›æµ‹å¼•æ“éƒ¨åˆ†

#### âŒ é‡æ„å‰ï¼ˆè€¦åˆï¼‰
```python
# å›æµ‹é€»è¾‘å’Œç­–ç•¥é€»è¾‘æ··åœ¨ä¸€èµ·
for date, row in df.iterrows():
    price = row['close']
    sig = row['signal']
    
    if selected_strategy == "æ³¢æ®µç­–ç•¥":
        # ç‰¹æ®Šçš„æ³¢æ®µç­–ç•¥é€»è¾‘ï¼ˆ100è¡Œï¼‰
        if position == 0 and not waiting_for_reentry and is_first_band:
            # å¤æ‚çš„ä¹°å…¥é€»è¾‘
        elif position == 0 and waiting_for_reentry:
            # å¤æ‚çš„é‡æ–°å…¥åœºé€»è¾‘
        elif position > 0:
            # å¤æ‚çš„åŠ ä»“æ­¢ç›ˆé€»è¾‘
    else:
        # æ ‡å‡†ç­–ç•¥é€»è¾‘
        if sig == 1 and position == 0:
            # ä¹°å…¥
        elif sig == -1 and position > 0:
            # å–å‡º
    
    equity_curve.append(cash + position * price)
```

#### âœ… é‡æ„åï¼ˆè§£è€¦ï¼‰
```python
# å›æµ‹å¼•æ“ç‹¬ç«‹
class BacktestEngine:
    def run(self, df, strategy):
        # è®¡ç®—ä¿¡å·
        df = strategy.calculate_signals(df)
        
        # æ ¹æ®ç­–ç•¥ç±»å‹é€‰æ‹©å›æµ‹é€»è¾‘
        if isinstance(strategy, WaveStrategy):
            return self._run_wave_backtest(df, strategy)
        else:
            return self._run_standard_backtest(df, strategy)
    
    def _run_standard_backtest(self, df, strategy):
        # æ¸…æ™°çš„æ ‡å‡†å›æµ‹é€»è¾‘
        pass
    
    def _run_wave_backtest(self, df, strategy):
        # æ¸…æ™°çš„æ³¢æ®µå›æµ‹é€»è¾‘
        pass
```

---

## ğŸ“ˆ ä»£ç è´¨é‡å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|------|--------|--------|------|
| **å•æ–‡ä»¶è¡Œæ•°** | 641è¡Œ | 280è¡Œ | â¬‡ï¸ 56% |
| **å‡½æ•°å¤æ‚åº¦** | é«˜ï¼ˆåµŒå¥—if-elifï¼‰ | ä½ï¼ˆå¤šæ€ï¼‰ | âœ… æ˜¾è‘—é™ä½ |
| **å¯æµ‹è¯•æ€§** | éš¾ï¼ˆä¾èµ–UIï¼‰ | æ˜“ï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰ | âœ… å¤§å¹…æå‡ |
| **å¯æ‰©å±•æ€§** | å·®ï¼ˆä¿®æ”¹ä¸»æ–‡ä»¶ï¼‰ | å¥½ï¼ˆæ·»åŠ ç±»ï¼‰ | âœ… è´¨çš„é£è·ƒ |
| **ä»£ç å¤ç”¨** | æ—  | é«˜ | âœ… æ¨¡å—å¯ç‹¬ç«‹ä½¿ç”¨ |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | ä½ | âœ… èŒè´£æ¸…æ™° |

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯å¯¹æ¯”

### åœºæ™¯1ï¼šæ·»åŠ æ–°çš„æ•°æ®æºï¼ˆå¦‚Tushareï¼‰

#### âŒ é‡æ„å‰
```python
# éœ€è¦ä¿®æ”¹ get_stock_data å‡½æ•°ï¼Œæ·»åŠ æ–°çš„ elif åˆ†æ”¯
# é£é™©ï¼šå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
# ä»£ç é‡ï¼šéœ€è¦åœ¨ä¸»æ–‡ä»¶ä¸­æ·»åŠ 50-100è¡Œ
```

#### âœ… é‡æ„å
```python
# åªéœ€æ·»åŠ ä¸€ä¸ªæ–°ç±»ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
class TushareDataSource(DataSource):
    def fetch_data(self, code, start_date, end_date, **kwargs):
        # å®ç°é€»è¾‘
        pass

# åœ¨å·¥å‚ä¸­æ³¨å†Œ
# ä»£ç é‡ï¼šç‹¬ç«‹æ–‡ä»¶ï¼Œçº¦50è¡Œ
```

---

### åœºæ™¯2ï¼šæ·»åŠ æ–°çš„äº¤æ˜“ç­–ç•¥ï¼ˆå¦‚KDJï¼‰

#### âŒ é‡æ„å‰
```python
# éœ€è¦åœ¨ä¸»æ–‡ä»¶çš„å¤§ if-elif å—ä¸­æ·»åŠ æ–°åˆ†æ”¯
# é£é™©ï¼šå¯èƒ½å½±å“å…¶ä»–ç­–ç•¥
# ä»£ç é‡ï¼šä¸»æ–‡ä»¶å¢åŠ 50-100è¡Œ
```

#### âœ… é‡æ„å
```python
# åªéœ€æ·»åŠ ä¸€ä¸ªæ–°ç±»
class KDJStrategy(Strategy):
    def calculate_signals(self, df):
        # å®ç°é€»è¾‘
        pass

# åœ¨å·¥å‚ä¸­æ³¨å†Œ
# ä»£ç é‡ï¼šç‹¬ç«‹å®ç°ï¼Œçº¦50è¡Œ
```

---

### åœºæ™¯3ï¼šæ‰¹é‡æµ‹è¯•å¤šä¸ªç­–ç•¥

#### âŒ é‡æ„å‰
```python
# éœ€è¦å¤šæ¬¡è¿è¡ŒStreamlitç•Œé¢ï¼Œæ‰‹åŠ¨è®°å½•ç»“æœ
# æ— æ³•è‡ªåŠ¨åŒ–
```

#### âœ… é‡æ„å
```python
# å¯ä»¥ç¼–å†™è„šæœ¬æ‰¹é‡æµ‹è¯•
strategies = [
    ("MACDè¶‹åŠ¿ç­–ç•¥", {...}),
    ("åŒå‡çº¿ç­–ç•¥(SMA)", {...}),
    ("RSIè¶…ä¹°è¶…å–", {...})
]

for name, params in strategies:
    strategy = StrategyFactory.create_strategy(name, params)
    result = engine.run(df, strategy)
    print(f"{name}: {result.total_return:.2%}")
```

---

### åœºæ™¯4ï¼šå•å…ƒæµ‹è¯•

#### âŒ é‡æ„å‰
```python
# éš¾ä»¥æµ‹è¯•ï¼Œå› ä¸ºæ‰€æœ‰é€»è¾‘éƒ½åœ¨UIä¸­
# éœ€è¦å¯åŠ¨æ•´ä¸ªStreamlitåº”ç”¨
```

#### âœ… é‡æ„å
```python
# å¯ä»¥ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªæ¨¡å—
def test_macd_strategy():
    strategy = MACDStrategy({'fast': 12, 'slow': 26, 'signal': 9})
    df = strategy.calculate_signals(test_data)
    assert 'signal' in df.columns
    assert df['signal'].isin([0, 1, -1]).all()

def test_backtest_engine():
    engine = BacktestEngine(100000, 0.0003)
    result = engine.run(test_data, test_strategy)
    assert result.final_equity > 0
```

---

## ğŸ’¡ å®é™…æ”¶ç›Š

### å¼€å‘æ•ˆç‡
- **æ·»åŠ æ–°åŠŸèƒ½ï¼š** ä»ä¿®æ”¹ä¸»æ–‡ä»¶å˜ä¸ºæ·»åŠ æ–°ç±» â†’ **æ•ˆç‡æå‡ 3x**
- **è°ƒè¯•é—®é¢˜ï¼š** ä»å…¨å±€æœç´¢å˜ä¸ºå®šä½æ¨¡å— â†’ **æ•ˆç‡æå‡ 5x**
- **ä»£ç å®¡æŸ¥ï¼š** ä»é˜…è¯»600è¡Œå˜ä¸ºé˜…è¯»100è¡Œ â†’ **æ•ˆç‡æå‡ 6x**

### ä»£ç è´¨é‡
- **è€¦åˆåº¦ï¼š** é«˜ â†’ ä½
- **å†…èšæ€§ï¼š** ä½ â†’ é«˜
- **å¯è¯»æ€§ï¼š** å·® â†’ ä¼˜
- **å¯ç»´æŠ¤æ€§ï¼š** éš¾ â†’ æ˜“

### å›¢é˜Ÿåä½œ
- **å¹¶è¡Œå¼€å‘ï¼š** ä¸å¯èƒ½ â†’ å¯èƒ½ï¼ˆä¸åŒäººå¼€å‘ä¸åŒæ¨¡å—ï¼‰
- **ä»£ç å†²çªï¼š** é¢‘ç¹ â†’ ç½•è§
- **çŸ¥è¯†ä¼ é€’ï¼š** å›°éš¾ â†’ å®¹æ˜“ï¼ˆæ¨¡å—èŒè´£æ¸…æ™°ï¼‰

---

## ğŸ“ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. æŠ½è±¡å·¥å‚æ¨¡å¼
```python
DataSourceFactory.create_data_source('akshare')
StrategyFactory.create_strategy('MACDè¶‹åŠ¿ç­–ç•¥', params)
```

### 2. ç­–ç•¥æ¨¡å¼
```python
class Strategy(ABC):
    @abstractmethod
    def calculate_signals(self, df):
        pass
```

### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼
```python
class BacktestEngine:
    def run(self, df, strategy):
        df = strategy.calculate_signals(df)  # æ¨¡æ¿æ–¹æ³•
        return self._execute_backtest(df)
```

---

## ğŸ“š å­¦ä¹ ä»·å€¼

### å¯¹åˆå­¦è€…
- âœ… å­¦ä¹ é¢å‘å¯¹è±¡è®¾è®¡
- âœ… ç†è§£è®¾è®¡æ¨¡å¼åº”ç”¨
- âœ… æŒæ¡æ¨¡å—åŒ–æ€ç»´

### å¯¹è¿›é˜¶è€…
- âœ… å­¦ä¹ æ¶æ„è®¾è®¡
- âœ… ç†è§£è§£è€¦åˆæŠ€å·§
- âœ… æŒæ¡æ‰©å±•æ€§è®¾è®¡

### å¯¹ä¸“ä¸šå¼€å‘è€…
- âœ… å‚è€ƒé‡æ„å®è·µ
- âœ… å­¦ä¹ ä»£ç ç»„ç»‡
- âœ… æå‡å·¥ç¨‹èƒ½åŠ›

---

## ğŸ‰ æ€»ç»“

| æ–¹é¢ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| **ä»£ç ç»„ç»‡** | âŒ å•æ–‡ä»¶æ··ä¹± | âœ… å¤šæ¨¡å—æ¸…æ™° |
| **èŒè´£åˆ’åˆ†** | âŒ åŠŸèƒ½è€¦åˆ | âœ… èŒè´£å•ä¸€ |
| **æ‰©å±•æ€§** | âŒ ä¿®æ”¹ä¸»æ–‡ä»¶ | âœ… æ·»åŠ æ–°ç±» |
| **æµ‹è¯•æ€§** | âŒ éš¾ä»¥æµ‹è¯• | âœ… æ˜“äºæµ‹è¯• |
| **å¤ç”¨æ€§** | âŒ æ— æ³•å¤ç”¨ | âœ… æ¨¡å—ç‹¬ç«‹ |
| **ç»´æŠ¤æ€§** | âŒ ç»´æŠ¤å›°éš¾ | âœ… ç»´æŠ¤ç®€å• |
| **å›¢é˜Ÿåä½œ** | âŒ å†²çªé¢‘ç¹ | âœ… å¹¶è¡Œå¼€å‘ |

**ç»“è®ºï¼š** æ¨¡å—åŒ–é‡æ„å¸¦æ¥äº†å…¨æ–¹ä½çš„æå‡ï¼Œæ˜¯ä¸€æ¬¡æˆåŠŸçš„æ¶æ„ä¼˜åŒ–ï¼âœ¨

---

**é‡æ„æ—¶é—´ï¼š** 2026-02-07  
**é‡æ„åŸåˆ™ï¼š** å•ä¸€èŒè´£ã€å¼€é—­åŸåˆ™ã€ä¾èµ–å€’ç½®  
**è®¾è®¡æ¨¡å¼ï¼š** å·¥å‚æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼

