# ✅ 数据源选择功能已完成

## 🎉 新增功能

### 核心更新
在Streamlit界面中新增了**数据源选择**功能，用户可以在以下数据源之间自由切换：

1. **AKShare** - 专注A股和港股数据
2. **YFinance** - 支持全球市场和加密货币

---

## 📊 功能展示

### 界面变化

#### 1. 数据源选择器（新增）
```
📊 数据源
├─ AKShare (A股/港股)
└─ YFinance (全球市场/加密货币)
```

#### 2. 动态市场选项
根据选择的数据源，自动调整可用市场：

**AKShare数据源：**
- 🇨🇳 A股
- 🇭🇰 港股
- 🇺🇸 美股

**YFinance数据源：**
- 🇺🇸 美股
- 🇭🇰 港股
- 💎 加密货币

#### 3. 智能代码提示
根据数据源和市场类型，显示相应的代码格式提示：

| 数据源 | 市场 | 代码格式 | 示例 |
|--------|------|----------|------|
| AKShare | A股 | 6位数字 | `000001`, `600519` |
| AKShare | 港股 | 5位数字 | `00700`, `09988` |
| YFinance | 美股 | 股票代码 | `AAPL`, `TSLA` |
| YFinance | 港股 | 代码.HK | `0700.HK`, `9988.HK` |
| YFinance | 加密货币 | XXX-USD | `BTC-USD`, `ETH-USD` |

---

## 🚀 使用方法

### 步骤1：选择数据源
在侧边栏顶部选择数据源：
```
📊 数据源
  ▼ AKShare (A股/港股)
    YFinance (全球市场/加密货币)
```

### 步骤2：选择市场
根据数据源，选择要分析的市场类型

### 步骤3：输入代码
根据提示输入正确格式的代码

### 步骤4：设置参数
设置回测区间、初始资金、策略等

### 步骤5：开始回测
点击【🚀 开始回测】按钮

---

## 💡 使用场景

### 场景1：分析A股市场
```
数据源：AKShare (A股/港股)
市场：A股
代码：000001 (平安银行)
```
**适用于：** 国内投资者分析A股市场

### 场景2：分析美股科技股
```
数据源：YFinance (全球市场/加密货币)
市场：美股
代码：AAPL (苹果)
```
**适用于：** 投资美股的用户

### 场景3：分析港股
```
方式A - 使用AKShare:
  数据源：AKShare
  市场：港股
  代码：00700 (腾讯)

方式B - 使用YFinance:
  数据源：YFinance
  市场：港股
  代码：0700.HK (腾讯)
```
**适用于：** 港股投资者（两种方式都可以）

### 场景4：分析加密货币
```
数据源：YFinance (全球市场/加密货币)
市场：加密货币
代码：BTC-USD (比特币)
```
**适用于：** 数字货币投资者

---

## 🎯 代码格式速查表

### AKShare数据源

| 市场 | 格式 | 示例 | 说明 |
|------|------|------|------|
| A股 | 6位数字 | `000001`, `600519`, `000858` | 深市或沪市代码 |
| 港股 | 5位数字 | `00700`, `09988`, `01810` | 港交所代码（保留前导零）|
| 美股 | 股票代码 | `AAPL`, `TSLA` | 部分支持 |

### YFinance数据源

| 市场 | 格式 | 示例 | 说明 |
|------|------|------|------|
| 美股 | 股票代码 | `AAPL`, `TSLA`, `MSFT`, `NVDA` | 纳斯达克、纽交所等 |
| 港股 | 代码.HK | `0700.HK`, `9988.HK`, `1810.HK` | 必须加.HK后缀 |
| 加密货币 | XXX-USD | `BTC-USD`, `ETH-USD`, `BNB-USD` | 主流加密货币 |

---

## 📝 详细示例

### 示例1：回测平安银行（A股）

**设置：**
- 数据源：`AKShare (A股/港股)`
- 市场：`A股`
- 代码：`000001`
- 策略：`MACD趋势策略`
- 回测区间：`2023-01-01` 至 `2024-01-01`

**执行：**
点击【开始回测】→ 系统自动使用AKShare获取平安银行数据 → 运行MACD策略 → 显示回测结果

---

### 示例2：回测苹果股票（美股）

**设置：**
- 数据源：`YFinance (全球市场/加密货币)`
- 市场：`美股`
- 代码：`AAPL`
- 策略：`双均线策略(SMA)`
- 回测区间：`2023-01-01` 至 `2024-01-01`

**执行：**
点击【开始回测】→ 系统自动使用YFinance获取苹果股票数据 → 运行双均线策略 → 显示回测结果

---

### 示例3：回测腾讯控股（港股 - YFinance）

**设置：**
- 数据源：`YFinance (全球市场/加密货币)`
- 市场：`港股`
- 代码：`0700.HK` ⚠️ 注意格式
- 策略：`RSI超买超卖`
- 回测区间：`2023-01-01` 至 `2024-01-01`

**执行：**
点击【开始回测】→ 系统使用YFinance获取腾讯数据 → 运行RSI策略 → 显示回测结果

---

### 示例4：回测比特币（加密货币）

**设置：**
- 数据源：`YFinance (全球市场/加密货币)`
- 市场：`加密货币`
- 代码：`BTC-USD`
- 策略：`布林带突破`
- 回测区间：`2023-01-01` 至 `2024-01-01`

**执行：**
点击【开始回测】→ 系统使用YFinance获取比特币数据 → 运行布林带策略 → 显示回测结果

---

## 🔧 技术实现

### 代码变更

#### 1. 添加数据源选择器
```python
data_source = st.sidebar.selectbox(
    "📊 数据源",
    ["AKShare (A股/港股)", "YFinance (全球市场/加密货币)"],
    help="选择数据获取来源"
)
```

#### 2. 动态市场选项
```python
if "AKShare" in data_source:
    source_type = "akshare"
    market_options = ["A股", "港股", "美股"]
else:
    source_type = "yfinance"
    market_options = ["美股", "港股", "加密货币"]
```

#### 3. 智能代码输入
根据`source_type`和`market_type`组合，显示不同的输入提示和默认值

#### 4. 数据获取
```python
df = get_stock_data(
    stock_code, 
    start_date, 
    end_date, 
    market=market_type, 
    source_type=source_type  # 使用用户选择的数据源
)
```

---

## 🎨 界面优化

### 1. 回测报告标题
显示数据源信息：
```
📊 量化回测报告：🇺🇸 AAPL
数据源：YFinance | 市场：美股
```

### 2. 加载提示
显示当前使用的数据源：
```
正在从 YFinance 拉取数据并进行量化计算...
```

### 3. 欢迎页面
详细的数据源说明和代码示例表格

---

## ⚠️ 注意事项

### 1. 代码格式差异

| 项目 | AKShare | YFinance |
|------|---------|----------|
| 港股格式 | `00700` | `0700.HK` |
| 是否需要后缀 | ❌ 不需要 | ✅ 需要.HK |
| 加密货币 | ❌ 不支持 | ✅ 支持 |

### 2. 数据源选择建议

**推荐使用AKShare的情况：**
- 主要分析A股市场
- 需要港股数据（两者皆可，看个人喜好）
- 已熟悉AKShare代码格式

**推荐使用YFinance的情况：**
- 分析美股市场
- 需要加密货币数据
- 需要全球多市场对比
- 偏好国际标准的数据格式

### 3. 常见错误

**错误1：港股代码格式不对**
```
❌ 使用YFinance时输入 00700
✅ 应该输入 0700.HK
```

**错误2：数据源与市场不匹配**
```
❌ 使用AKShare获取加密货币（不支持）
✅ 使用YFinance获取加密货币
```

---

## 📊 功能对比

### 数据源对比表

| 特性 | AKShare | YFinance |
|------|---------|----------|
| A股支持 | ✅ 完整 | ⚠️ 有限 |
| 港股支持 | ✅ 完整 | ✅ 完整 |
| 美股支持 | ⚠️ 有限 | ✅ 完整 |
| 加密货币 | ❌ 不支持 | ✅ 完整 |
| 代码格式 | 本地标准 | 国际标准 |
| 使用难度 | 😊 简单 | 😊 简单 |
| 数据质量 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 更新速度 | 快 | 中等 |

---

## 🎓 学习建议

### 新手用户
1. 先从熟悉的市场开始（如A股用户用AKShare）
2. 尝试不同的数据源，对比数据差异
3. 注意代码格式的区别

### 进阶用户
1. 利用不同数据源进行跨市场分析
2. 对比同一标的在不同数据源的表现
3. 探索加密货币等新兴资产类别

---

## 🔮 未来扩展

### 可能的增强
- [ ] 支持更多数据源（如Tushare、东方财富等）
- [ ] 数据源性能对比功能
- [ ] 自动选择最优数据源
- [ ] 数据源缓存机制
- [ ] 多数据源数据融合

---

## 📞 使用帮助

### 遇到问题？

1. **数据获取失败**
   - 检查代码格式是否正确
   - 确认数据源支持该市场
   - 查看详细错误提示

2. **代码格式不确定**
   - 查看输入框下方的帮助提示
   - 参考本文档的代码格式表格
   - 查看欢迎页面的示例

3. **不知道选哪个数据源**
   - A股 → AKShare
   - 美股 → YFinance
   - 加密货币 → YFinance
   - 港股 → 两者都可以

---

## ✅ 更新清单

- [x] 添加数据源选择器
- [x] 实现动态市场选项
- [x] 智能代码输入提示
- [x] 更新数据获取逻辑
- [x] 优化回测报告显示
- [x] 更新欢迎页面
- [x] 添加详细文档
- [x] 测试所有场景
- [x] 无语法错误

---

## 🎊 总结

### 核心价值
✅ **灵活性** - 可根据需求选择不同数据源  
✅ **易用性** - 智能提示和默认值  
✅ **扩展性** - 未来可轻松添加更多数据源  
✅ **完整性** - 覆盖全球主要市场  

### 使用体验
- 🎯 一键切换数据源
- 💡 智能格式提示
- 🚀 即选即用
- 📊 完整的回测功能

**现在就试试新的数据源选择功能，探索全球金融市场！** 🌍

---

**完成时间：** 2026-02-07  
**版本：** 2.0  
**状态：** ✅ 已完成并可用  
**访问地址：** http://localhost:8502

